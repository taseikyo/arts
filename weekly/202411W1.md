> @Author  : Lewis Tian (taseikyo@gmail.com)
>
> @Link    : github.com/taseikyo
>
> @Range   : 2025-03-18 - 2025-03-18

# Weekly #87

[readme](../README.md) | [previous](202410W5.md) | [next](202411W2.md)

![](../images/2024/11/serenay-tosun-_zsMDxFp9ZU-unsplash.jpg "Weekly #87")

\**Photo by [Serenay Tosun](https://unsplash.com/@serenaytosun) on [Unsplash](https://unsplash.com/photos/a-woman-walking-along-a-beach-next-to-the-ocean-_zsMDxFp9ZU)*

## Table of Contents

- [algorithm](#algorithm-)
- [review](#review-)
	- Redis 批量查询技巧
- [tip](#tip-)
- [share](#share-)

## algorithm [🔝](#weekly-87)

## review [🔝](#weekly-87)

### 1. [Redis 批量查询技巧](https://www.cnblogs.com/kukuxjx/p/18017252)

#### 1.  前言

Redis，我们做开发的想必都用过，他是一种缓存，主要用于快速响应结果嘛。比如我们要获取商品的详情，有日销量、月销量、库存数量、评价数量，这些数据都在 Redis 缓存中，那么我们是要拿四趟？还是一趟呢？当然是一趟最好呀。接下来我们来看看为什么我们要一趟这么做，以及怎么做。

#### 2. 为什么需要批量执行命令

我们看一下交互过程：

![](../images/2024/11/990230-20240216161959581-1160391444.png)

每次客户端发送一个一个请求命令，Redis 服务端接收到命令后，将命令放在队列内，一个一个命令执行，并将结果返回。

批量执行命令有三点优势：

- 提高命令执行效率，减少了网络延迟，从而提高了 Redis 服务器的响应速度。批量执行减少了每个命令的单独网络传输开销，有效降低了往返时间（RTT）。
- 简化客户端逻辑，通过将多个命令封装成一个操作，客户端的处理逻辑变得更加简洁和清晰。这使得客户端代码更易读、易维护。
- 提升事务性能，批量执行命令能够确保一组命令在同一时间内执行，从而提高了事务的性能。这对于需要保持原子性的操作尤为重要，确保一组命令要么全部执行成功，要么全部失败。

接下来，我们详细讲解批量查询的四种方式。

- 字符串 MGET 命令
- 哈希表 HMGET 命令
- 管道技术
- Lua 脚本

#### 3. 批量查询

3.1、字符串 MGET 命令

MGET 接受一个或多个键作为参数，返回与这些键关联的值。

![](../images/2024/11/990230-20240216162206842-1974603200.png)

- key1, key2, ..., keyN：要获取值的键列表。
- MGET 返回一个包含相应值的列表，如果键不存在，则对应的位置返回 nil。

![](../images/2024/11/990230-20240216162238622-1469616722.png)

3.2、哈希表 HMGET 命令

HMGET 接受一个哈希表的键以及一个或多个字段名作为参数，返回与这些字段名关联的值。

![](../images/2024/11/990230-20240216162433451-277934796.png)

如果给定的域不存在于哈希表，那么返回一个 nil 值。

![](../images/2024/11/990230-20240216162450212-1790580784.png)

3.3、管道技术

Redis Pipeline（管道）命令是一种优化网络通信的技术，可以将多个命令一次性发送给 Redis 服务器，可以减少客户端与 Redis 服务器之间的网络通信次数。

![](../images/2024/11/990230-20240216162559308-1314786056.png)

客户端将多个命令一次性发送给 Redis 服务器，Redis 服务器缓存这些命令，并一次性执行，最后将执行结果一次性返回给客户端。

通过使用 Redis Pipeline，显而易见的好处是避免了在每个命令执行时都进行一次网络通信，从而显著降低了时间开销。

**1 次 pipeline（n条命令） = 1 次网络时间 + 执行n 条命令时间**

3.4、Lua 脚本

Redis Lua 脚本是一种在 Redis 服务器上执行的脚本语言，基于 Lua 编程语言。

这种脚本可以包含多个 Redis 命令，而且它们在 Redis 服务器上以原子性操作的方式执行。通过使用 Lua 脚本，你可以在服务器端执行一系列的 Redis 命令，而不需要将它们一条一条地发送到服务器。

Redis 执行 Lua 脚本有两种执行方式：Eval 和 EvalSHA 。

3.4.1、Eval

![](../images/2024/11/990230-20240216162858665-639064695.png)

EVAL命令的执行过程主要可以分为三个步骤：

1. 根据客户端提供的 Lua 脚本，在 Lua 环境中定义一个 Lua 函数。Lua 函数的名称实际上是以 "f_" 为前缀加上脚本本身计算出的 SHA1 值，例如 f_ddfsdfjgjbg33rndgj00，其中 SHA1 的长度为 40 字符。函数体则是脚本本身。
2. 将客户端提供的脚本保存到 lua_scripts 字典中。简单来说，就是添加一个键值对，其中键是 Lua 脚本的 SHA1 校验和，值是 Lua 脚本本身。这主要是为了以后能够复用这个脚本。
3. 执行第一步在 Lua 环境中定义的函数，从而执行客户端提供的 Lua 脚本。这个过程利用了在步骤二中保存的 SHA1 校验和来调用对应的 Lua 函数。

这个流程使得 Redis 能够高效地处理客户端提供的 Lua 脚本，同时通过缓存 SHA1 校验和，可以减少重复传输脚本的开销，提高效率。

在 Redis 中，使用了 Key 列表和参数列表来为 Lua 脚本提供更多的灵活性，执行 Eval 命令的格式为：

![](../images/2024/11/990230-20240216162919431-977115616.png)

下图演示下 Lua 如何调用 Redis 命令 ，通过 `redis.call()` 来执行了 Redis 命令 。

![](../images/2024/11/990230-20240216162934084-425556962.png)

3.4.2、EvalSHA

与 EVAL 不同，EVALSHA 的主要目的是通过脚本的 SHA1 校验和来执行预先在服务器端加载的 Lua 脚本，从而避免重复传输脚本的开销。

![](../images/2024/11/990230-20240216163026849-1706743754.png)

使用步骤：

（1）加载 Lua 脚本到 Redis 服务端：

首先，将 Lua 脚本加载到 Redis 服务端。这可以通过 SCRIPT LOAD 命令完成。执行 SCRIPT LOAD 后，会返回一个 SHA1 校验和，该值唯一标识了加载的 Lua 脚本。

![](../images/2024/11/990230-20240216163053855-1390688874.png)

这会返回 SHA1 校验和: a1104f2250e5dd9fc10c3c681ddb389e7bd4a2cf。

（2）执行 Lua 脚本：

一旦 Lua 脚本被加载并获得了 SHA1 校验和，之后就可以使用 EVALSHA 命令来执行该脚本。

![](../images/2024/11/990230-20240216163118827-129674232.png)

## tip [🔝](#weekly-87)

## share [🔝](#weekly-87)

[readme](../README.md) | [previous](202410W5.md) | [next](202411W2.md)
