> @Author  : Lewis Tian (taseikyo@gmail.com)
>
> @Link    : github.com/taseikyo
>
> @Range   : 2024-12-08 - 2024-12-14

# Weekly #92

[readme](../README.md) | [previous](202412W1.md) | [next](202412W3.md)

![](../images/2024/12/jeferson-gomes-Ymq0SnUNN7A-unsplash.jpg "Weekly #92")

\**Photo by [JEFERSON GOMES](https://unsplash.com/@daluz) on [Unsplash](https://unsplash.com/photos/woman-in-blue-denim-vest-wearing-black-sunglasses-Ymq0SnUNN7A)*

## Table of Contents

- [algorithm](#algorithm-)
- [review](#review-)
	- e820ç®€ä»‹
- [tip](#tip-)
- [share](#share-)

## algorithm [ğŸ”](#weekly-92)

## review [ğŸ”](#weekly-92)

### 1. [e820ç®€ä»‹](https://blog.csdn.net/gxfan/article/details/2962236)

e820 æ˜¯å’Œ BIOS çš„ä¸€ä¸ªä¸­æ–­ç›¸å…³çš„ï¼Œå…·ä½“è¯´æ˜¯ int 0x15ã€‚ä¹‹æ‰€ä»¥å« e820 æ˜¯å› ä¸ºåœ¨ç”¨è¿™ä¸ªä¸­æ–­æ—¶ ax å¿…é¡»æ˜¯ 0xe820ã€‚è¿™ä¸ªä¸­æ–­çš„ä½œç”¨æ˜¯å¾—åˆ°ç³»ç»Ÿçš„å†…å­˜å¸ƒå±€ã€‚å› ä¸ºç³»ç»Ÿå†…å­˜ä¼šæœ‰å¾ˆå¤šæ®µï¼Œæ¯æ®µçš„ç±»å‹å±æ€§ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¸ªæŸ¥è¯¢æ˜¯ â€œè¿­ä»£å¼â€ çš„ï¼Œæ¯æ¬¡æ±‚å¾—ä¸€ä¸ªæ®µã€‚

æˆ‘ä»¬çœ‹å†…æ ¸æºä»£ç ã€‚ä¸»è¦æ¶‰åŠä¸¤ä¸ªæ–‡ä»¶ï¼š`arch/x86/boot/memory.c` å’Œ `arch/x86/kernel/e820_32.c`ã€‚æˆ‘ä»¬ å·²ç»å¾ˆå¹¸è¿äº†ï¼Œè¿™éƒ¨åˆ†ä»£ç å·²ç»ç”¨ C é‡å†™è¿‡äº†ã€‚ä½ å¯èƒ½ä¼šå¥‡æ€ªï¼Œå¯åŠ¨è°ƒç”¨ e820 æ—¶æˆ‘ä»¬è¿˜åœ¨å®æ¨¡å¼ï¼Œæ€ä¹ˆèƒ½ç”¨ C å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œè¿™é‡Œç”¨çš„æ˜¯ 16 ä½çš„ Cã€‚gcc æ—©å·² ç»æ”¯æŒ. code16 gcc æ¨¡å¼äº†ã€‚

çœ‹ detect_memory_e820() å‡½æ•°ï¼Œé‡Œé¢å°±æ˜¯ e820 çš„æœ¬è´¨ã€‚å®ƒæŠŠ int 0x15 æ”¾åˆ°ä¸€ä¸ª do-while å¾ªç¯é‡Œï¼Œæ¯æ¬¡å¾—åˆ°çš„ä¸€ä¸ªå†…å­˜æ®µæ”¾åˆ° `struct e820entry` é‡Œï¼Œè€Œ `struct e820entry` çš„ç»“æ„æ­£æ˜¯ e820 è¿”å›ç»“æœçš„ç»“æ„ï¼è€Œåƒå…¶å®ƒå¯åŠ¨æ—¶è·å¾—çš„ç»“æœä¸€æ ·ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«æ”¾åˆ° boot_params é‡Œï¼Œe820 è¢«æ”¾åˆ°äº† `boot_params.e820_map`ã€‚

å¦‚æœä½ å¯¹ `struct e820entry` è¿˜æœ‰ç–‘é—®ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ `arch/x86/kernel/e820_32.c::print_memory_map()`ï¼Œçœ‹çœ‹é‡Œé¢æ˜¯æ€ä¹ˆä½¿ç”¨å®ƒçš„ã€‚

å½“ç„¶äº†ï¼Œåœ¨ `arch/x86/boot/memory.c` é‡Œï¼Œä½ è¿˜ä¼šçœ‹åˆ°å¦å¤–ä¸¤ä¸ªåˆ©ç”¨ int 0x15 æŸ¥è¯¢å†…å­˜çš„å‡½æ•°ï¼Œä¸è¿‡ç”¨é€”ä¸ä¸€æ ·äº†ã€‚

é™„ï¼š

boot_params ç»“æ„ä½“å®šä¹‰ï¼Œå…¶ä¸­ E820MAX å®šä¹‰ä¸º 128:

```c
struct e820entry {
	__u64 addr;
	/* start of memory segment */
	__u64 size;
	/* size of memory segment */
	__u32 type;
	/* type of memory segment */
}
__attribute__((packed));
struct boot_params {
	struct screen_info screen_info;
	/* 0x000 */
	struct apm_bios_info apm_bios_info;
	/* 0x040 */
	__u8  _pad2[12];
	/* 0x054 */
	struct ist_info ist_info;
	/* 0x060 */
	__u8  _pad3[16];
	/* 0x070 */
	__u8  hd0_info[16];
	/* obsolete! */
	/* 0x080 */
	__u8  hd1_info[16];
	/* obsolete! */
	/* 0x090 */
	struct sys_desc_table sys_desc_table;
	/* 0x0a0 */
	__u8  _pad4[144];
	/* 0x0b0 */
	struct edid_info edid_info;
	/* 0x140 */
	struct efi_info efi_info;
	/* 0x1c0 */
	__u32 alt_mem_k;
	/* 0x1e0 */
	__u32 scratch;
	/* Scratch field! */
	/* 0x1e4 */
	__u8  e820_entries;
	/* 0x1e8 */
	__u8  eddbuf_entries;
	/* 0x1e9 */
	__u8  edd_mbr_sig_buf_entries;
	/* 0x1ea */
	__u8  _pad6[6];
	/* 0x1eb */
	struct setup_header hdr;
	/* setup header */
	/* 0x1f1 */
	__u8  _pad7[0x290-0x1f1-sizeof(struct setup_header)];
	__u32 edd_mbr_sig_buffer[EDD_MBR_SIG_MAX];
	/* 0x290 */
	struct e820entry e820_map[E820MAX];
	/* 0x2d0 */
	__u8  _pad8[48];
	/* 0xcd0 */
	struct edd_info eddbuf[EDDMAXNR];
	/* 0xd00 */
	__u8  _pad9[276];
	/* 0xeec */
}
__attribute__((packed));
```

é€šè¿‡ bios è·å–ç³»ç»Ÿå†…å­˜å¸ƒå±€ä»£ç å¦‚ä¸‹ï¼š

```C
static int detect_memory_e820(void) {
	int count = 0;
	u32 next = 0;
	u32 size, id;
	u8 err;
	struct e820entry *desc = boot_params.e820_map;
	do {
		size = sizeof(struct e820entry);
		/* Important: %edx is clobbered by some BIOSes,
		so it must be either used for the error output
		or explicitly marked clobbered. */
		asm("int $0x15; setc %0"
			: "=d" (err), "+b" (next), "=a" (id), "+c" (size), "=m" (*desc)
			: "D" (desc), "d" (SMAP), "a" (0xe820));
		/* BIOSes which terminate the chain with CF = 1 as opposed
		to %ebx = 0 don't always report the SMAP signature on
		the final, failing, probe. */
		if (err)
				 break;
		/* Some BIOSes stop returning SMAP in the middle of
		the search loop.  We don't know exactly how the BIOS
		screwed up the map at that point, we might have a
		partial map, the full map, or complete garbage, so
		just return failure. */
		if (id != SMAP) {
			count = 0;
			break;
		}
		count++;
		desc++;
	}
	while (next && count < E820MAX);
	return boot_params.e820_entries = count;
}
```

è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œboot_params.e820_map å°±å«æœ‰äº†ç³»ç»Ÿå†…å­˜å¸ƒå±€å›¾ã€‚

å‡½æ•°å…³é”®éƒ¨åˆ†è§£é‡Šå¦‚ä¸‹ï¼š

07 è·å–å¯åŠ¨å‚æ•° boot_params é‡Œçš„ e820_map æ•°ç»„é¦–åœ°å€ã€‚

15-18 é€šè¿‡ä¸­æ–­ 0x15 è°ƒç”¨ bios ä¾‹ç¨‹è·å¾—ä¸€ä¸ªå†…å­˜æ®µçš„ä¿¡æ¯ï¼Œè¿™æ¡è¯­å¥æ˜¯æŒ‰ç…§ AT&T çš„æ±‡ç¼–è¯­æ³•æ ¼å¼å†™çš„ï¼Œå…·ä½“è¯­æ³•å¯ä»¥æŸ¥çœ‹ç›¸å…³èµ„æ–™ã€‚

## tip [ğŸ”](#weekly-92)

## share [ğŸ”](#weekly-92)

[readme](../README.md) | [previous](202412W1.md) | [next](202412W3.md)
