> @Author  : Lewis Tian (taseikyo@gmail.com)
>
> @Link    : github.com/taseikyo
>
> @Range   : 2024-12-08 - 2024-12-14

# Weekly #92

[readme](../README.md) | [previous](202412W1.md) | [next](202412W3.md)

![](../images/2024/12/vitolda-klein-zMcXi4Jwyng-unsplash.jpg "Weekly #92")

\**Photo by [Vitolda Klein](https://unsplash.com/@little_klein) on [Unsplash](https://unsplash.com/photos/woman-in-black-long-sleeve-shirt-with-white-scarf-zMcXi4Jwyng)*

## Table of Contents

- [algorithm](#algorithm-)
- [review](#review-)
	- e820ç®€ä»‹
	- çƒ‚å¤§è¡—çš„ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿å’Œç¼“å­˜é›ªå´©ï¼Œä½ çœŸçš„æ‡‚äº†ï¼Ÿ
	- C++ è™šå‡½æ•°è¡¨å‰–æ
- [tip](#tip-)
- [share](#share-)
	- å—é£æ³•åˆ™

## algorithm [ğŸ”](#weekly-92)

## review [ğŸ”](#weekly-92)

### 1. [e820ç®€ä»‹](https://blog.csdn.net/gxfan/article/details/2962236)

e820 æ˜¯å’Œ BIOS çš„ä¸€ä¸ªä¸­æ–­ç›¸å…³çš„ï¼Œå…·ä½“è¯´æ˜¯ int 0x15ã€‚ä¹‹æ‰€ä»¥å« e820 æ˜¯å› ä¸ºåœ¨ç”¨è¿™ä¸ªä¸­æ–­æ—¶ ax å¿…é¡»æ˜¯ 0xe820ã€‚è¿™ä¸ªä¸­æ–­çš„ä½œç”¨æ˜¯å¾—åˆ°ç³»ç»Ÿçš„å†…å­˜å¸ƒå±€ã€‚å› ä¸ºç³»ç»Ÿå†…å­˜ä¼šæœ‰å¾ˆå¤šæ®µï¼Œæ¯æ®µçš„ç±»å‹å±æ€§ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¸ªæŸ¥è¯¢æ˜¯ â€œè¿­ä»£å¼â€ çš„ï¼Œæ¯æ¬¡æ±‚å¾—ä¸€ä¸ªæ®µã€‚

æˆ‘ä»¬çœ‹å†…æ ¸æºä»£ç ã€‚ä¸»è¦æ¶‰åŠä¸¤ä¸ªæ–‡ä»¶ï¼š`arch/x86/boot/memory.c` å’Œ `arch/x86/kernel/e820_32.c`ã€‚æˆ‘ä»¬ å·²ç»å¾ˆå¹¸è¿äº†ï¼Œè¿™éƒ¨åˆ†ä»£ç å·²ç»ç”¨ C é‡å†™è¿‡äº†ã€‚ä½ å¯èƒ½ä¼šå¥‡æ€ªï¼Œå¯åŠ¨è°ƒç”¨ e820 æ—¶æˆ‘ä»¬è¿˜åœ¨å®æ¨¡å¼ï¼Œæ€ä¹ˆèƒ½ç”¨ C å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œè¿™é‡Œç”¨çš„æ˜¯ 16 ä½çš„ Cã€‚gcc æ—©å·² ç»æ”¯æŒ. code16 gcc æ¨¡å¼äº†ã€‚

çœ‹ detect_memory_e820() å‡½æ•°ï¼Œé‡Œé¢å°±æ˜¯ e820 çš„æœ¬è´¨ã€‚å®ƒæŠŠ int 0x15 æ”¾åˆ°ä¸€ä¸ª do-while å¾ªç¯é‡Œï¼Œæ¯æ¬¡å¾—åˆ°çš„ä¸€ä¸ªå†…å­˜æ®µæ”¾åˆ° `struct e820entry` é‡Œï¼Œè€Œ `struct e820entry` çš„ç»“æ„æ­£æ˜¯ e820 è¿”å›ç»“æœçš„ç»“æ„ï¼è€Œåƒå…¶å®ƒå¯åŠ¨æ—¶è·å¾—çš„ç»“æœä¸€æ ·ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«æ”¾åˆ° boot_params é‡Œï¼Œe820 è¢«æ”¾åˆ°äº† `boot_params.e820_map`ã€‚

å¦‚æœä½ å¯¹ `struct e820entry` è¿˜æœ‰ç–‘é—®ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ `arch/x86/kernel/e820_32.c::print_memory_map()`ï¼Œçœ‹çœ‹é‡Œé¢æ˜¯æ€ä¹ˆä½¿ç”¨å®ƒçš„ã€‚

å½“ç„¶äº†ï¼Œåœ¨ `arch/x86/boot/memory.c` é‡Œï¼Œä½ è¿˜ä¼šçœ‹åˆ°å¦å¤–ä¸¤ä¸ªåˆ©ç”¨ int 0x15 æŸ¥è¯¢å†…å­˜çš„å‡½æ•°ï¼Œä¸è¿‡ç”¨é€”ä¸ä¸€æ ·äº†ã€‚

é™„ï¼š

boot_params ç»“æ„ä½“å®šä¹‰ï¼Œå…¶ä¸­ E820MAX å®šä¹‰ä¸º 128:

```c
struct e820entry {
	__u64 addr;
	/* start of memory segment */
	__u64 size;
	/* size of memory segment */
	__u32 type;
	/* type of memory segment */
}
__attribute__((packed));
struct boot_params {
	struct screen_info screen_info;
	/* 0x000 */
	struct apm_bios_info apm_bios_info;
	/* 0x040 */
	__u8  _pad2[12];
	/* 0x054 */
	struct ist_info ist_info;
	/* 0x060 */
	__u8  _pad3[16];
	/* 0x070 */
	__u8  hd0_info[16];
	/* obsolete! */
	/* 0x080 */
	__u8  hd1_info[16];
	/* obsolete! */
	/* 0x090 */
	struct sys_desc_table sys_desc_table;
	/* 0x0a0 */
	__u8  _pad4[144];
	/* 0x0b0 */
	struct edid_info edid_info;
	/* 0x140 */
	struct efi_info efi_info;
	/* 0x1c0 */
	__u32 alt_mem_k;
	/* 0x1e0 */
	__u32 scratch;
	/* Scratch field! */
	/* 0x1e4 */
	__u8  e820_entries;
	/* 0x1e8 */
	__u8  eddbuf_entries;
	/* 0x1e9 */
	__u8  edd_mbr_sig_buf_entries;
	/* 0x1ea */
	__u8  _pad6[6];
	/* 0x1eb */
	struct setup_header hdr;
	/* setup header */
	/* 0x1f1 */
	__u8  _pad7[0x290-0x1f1-sizeof(struct setup_header)];
	__u32 edd_mbr_sig_buffer[EDD_MBR_SIG_MAX];
	/* 0x290 */
	struct e820entry e820_map[E820MAX];
	/* 0x2d0 */
	__u8  _pad8[48];
	/* 0xcd0 */
	struct edd_info eddbuf[EDDMAXNR];
	/* 0xd00 */
	__u8  _pad9[276];
	/* 0xeec */
}
__attribute__((packed));
```

é€šè¿‡ bios è·å–ç³»ç»Ÿå†…å­˜å¸ƒå±€ä»£ç å¦‚ä¸‹ï¼š

```C
static int detect_memory_e820(void) {
	int count = 0;
	u32 next = 0;
	u32 size, id;
	u8 err;
	struct e820entry *desc = boot_params.e820_map;
	do {
		size = sizeof(struct e820entry);
		/* Important: %edx is clobbered by some BIOSes,
		so it must be either used for the error output
		or explicitly marked clobbered. */
		asm("int $0x15; setc %0"
			: "=d" (err), "+b" (next), "=a" (id), "+c" (size), "=m" (*desc)
			: "D" (desc), "d" (SMAP), "a" (0xe820));
		/* BIOSes which terminate the chain with CF = 1 as opposed
		to %ebx = 0 don't always report the SMAP signature on
		the final, failing, probe. */
		if (err)
				 break;
		/* Some BIOSes stop returning SMAP in the middle of
		the search loop.  We don't know exactly how the BIOS
		screwed up the map at that point, we might have a
		partial map, the full map, or complete garbage, so
		just return failure. */
		if (id != SMAP) {
			count = 0;
			break;
		}
		count++;
		desc++;
	}
	while (next && count < E820MAX);
	return boot_params.e820_entries = count;
}
```

è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œboot_params.e820_map å°±å«æœ‰äº†ç³»ç»Ÿå†…å­˜å¸ƒå±€å›¾ã€‚

å‡½æ•°å…³é”®éƒ¨åˆ†è§£é‡Šå¦‚ä¸‹ï¼š

07 è·å–å¯åŠ¨å‚æ•° boot_params é‡Œçš„ e820_map æ•°ç»„é¦–åœ°å€ã€‚

15-18 é€šè¿‡ä¸­æ–­ 0x15 è°ƒç”¨ bios ä¾‹ç¨‹è·å¾—ä¸€ä¸ªå†…å­˜æ®µçš„ä¿¡æ¯ï¼Œè¿™æ¡è¯­å¥æ˜¯æŒ‰ç…§ AT&T çš„æ±‡ç¼–è¯­æ³•æ ¼å¼å†™çš„ï¼Œå…·ä½“è¯­æ³•å¯ä»¥æŸ¥çœ‹ç›¸å…³èµ„æ–™ã€‚

### 2. [çƒ‚å¤§è¡—çš„ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿å’Œç¼“å­˜é›ªå´©ï¼Œä½ çœŸçš„æ‡‚äº†ï¼Ÿ](https://www.cnblogs.com/12lisu/p/15732213.html)

#### 1ã€ç¼“å­˜ç©¿é€é—®é¢˜

å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒåŠ ç¼“å­˜çš„ç›®çš„æ˜¯ï¼šä¸ºäº†å‡è½»æ•°æ®åº“çš„å‹åŠ›ï¼Œæå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚

1.1 æˆ‘ä»¬æ˜¯å¦‚ä½•ç”¨ç¼“å­˜çš„ï¼Ÿ

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰ç”¨æˆ·è¯·æ±‚è¿‡æ¥ï¼Œå…ˆæŸ¥ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨æ•°æ®ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™å†æŸ¥æ•°æ®åº“ï¼Œå¦‚æœæ•°æ®åº“ä¸­å­˜åœ¨ï¼Œåˆ™å°†æ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œç„¶åè¿”å›ã€‚å¦‚æœæ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›å¤±è´¥ã€‚

![](../images/2024/12/edcb8d41-a98b-45ca-8121-1a77f33b697c.jpg)


1.2 ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ

ä½†å¦‚æœå‡ºç°ä»¥ä¸‹è¿™ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚ï¼š

- ç”¨æˆ·è¯·æ±‚çš„ id åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨ã€‚
- æ¶æ„ç”¨æˆ·ä¼ªé€ ä¸å­˜åœ¨çš„ id å‘èµ·è¯·æ±‚ã€‚

è¿™æ ·çš„ç”¨æˆ·è¯·æ±‚å¯¼è‡´çš„ç»“æœæ˜¯ï¼šæ¯æ¬¡ä»ç¼“å­˜ä¸­éƒ½æŸ¥ä¸åˆ°æ•°æ®ï¼Œè€Œéœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼ŒåŒæ—¶æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰æŸ¥åˆ°è¯¥æ•°æ®ï¼Œä¹Ÿæ²¡æ³•æ”¾å…¥ç¼“å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡è¿™ä¸ªç”¨æˆ·è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œéƒ½è¦æŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ã€‚

![](../images/2024/12/264b84d3-f032-4c5a-af73-0a03fc2c5753.jpg)

1.3 æ ¡éªŒå‚æ•°

æˆ‘ä»¬å¯ä»¥å¯¹ç”¨æˆ· id åšæ£€éªŒã€‚

æ¯”å¦‚ä½ çš„åˆæ³• id æ˜¯ 15xxxxxxï¼Œä»¥ 15 å¼€å¤´çš„ã€‚å¦‚æœç”¨æˆ·ä¼ å…¥äº† 16 å¼€å¤´çš„ idï¼Œæ¯”å¦‚ï¼š16232323ï¼Œåˆ™å‚æ•°æ ¡éªŒå¤±è´¥ï¼Œç›´æ¥æŠŠç›¸å…³è¯·æ±‚æ‹¦æˆªæ‰ã€‚è¿™æ ·å¯ä»¥è¿‡æ»¤æ‰ä¸€éƒ¨åˆ†æ¶æ„ä¼ªé€ çš„ç”¨æˆ· idã€‚

1.4 å¸ƒéš†è¿‡æ»¤å™¨

å¦‚æœæ•°æ®æ¯”è¾ƒå°‘ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå…¨éƒ¨æ”¾åˆ°å†…å­˜çš„ä¸€ä¸ª map ä¸­ã€‚è¿™æ ·èƒ½å¤Ÿéå¸¸å¿«é€Ÿçš„è¯†åˆ«ï¼Œæ•°æ®åœ¨ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è®©å…¶è®¿é—®ç¼“å­˜ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥æ‹’ç»è¯¥è¯·æ±‚ã€‚

ä½†å¦‚æœæ•°æ®é‡å¤ªå¤šäº†ï¼Œæœ‰æ•°åƒä¸‡æˆ–è€…ä¸Šäº¿çš„æ•°æ®ï¼Œå…¨éƒ½æ”¾åˆ°å†…å­˜ä¸­ï¼Œå¾ˆæ˜¾ç„¶ä¼šå ç”¨å¤ªå¤šçš„å†…å­˜ç©ºé—´ã€‚

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰åŠæ³•å‡å°‘å†…å­˜ç©ºé—´å‘¢ï¼Ÿ

ç­”ï¼šè¿™å°±éœ€è¦ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨äº†ã€‚

å¸ƒéš†è¿‡æ»¤å™¨åº•å±‚ä½¿ç”¨ bit æ•°ç»„å­˜å‚¨æ•°æ®ï¼Œè¯¥æ•°ç»„ä¸­çš„å…ƒç´ é»˜è®¤å€¼æ˜¯ 0ã€‚å¸ƒéš†è¿‡æ»¤å™¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šæŠŠæ•°æ®åº“ä¸­æ‰€æœ‰å·²å­˜åœ¨çš„ keyï¼Œç»è¿‡ä¸€äº›åˆ—çš„ hash ç®—æ³•ï¼ˆæ¯”å¦‚ï¼šä¸‰æ¬¡ hash ç®—æ³•ï¼‰è®¡ç®—ï¼Œæ¯ä¸ª key éƒ½ä¼šè®¡ç®—å‡ºå¤šä¸ªä½ç½®ï¼Œç„¶åæŠŠè¿™äº›ä½ç½®ä¸Šçš„å…ƒç´ å€¼è®¾ç½®æˆ 1ã€‚

![](../images/2024/12/c1865319-8f21-4e57-b215-e1fc8b22326c.jpg)

ä¹‹åï¼Œæœ‰ç”¨æˆ· key è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œå†ç”¨ç›¸åŒçš„ hash ç®—æ³•è®¡ç®—ä½ç½®ã€‚

- å¦‚æœå¤šä¸ªä½ç½®ä¸­çš„å…ƒç´ å€¼éƒ½æ˜¯ 1ï¼Œåˆ™è¯´æ˜è¯¥ key åœ¨æ•°æ®åº“ä¸­å·²å­˜åœ¨ã€‚è¿™æ—¶å…è®¸ç»§ç»­å¾€åé¢æ“ä½œã€‚
- å¦‚æœæœ‰ 1 ä¸ªä»¥ä¸Šçš„ä½ç½®ä¸Šçš„å…ƒç´ å€¼æ˜¯ 0ï¼Œåˆ™è¯´æ˜è¯¥ key åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ã€‚è¿™æ—¶å¯ä»¥æ‹’ç»è¯¥è¯·æ±‚ï¼Œè€Œç›´æ¥è¿”å›ã€‚

ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ç¡®å®å¯ä»¥è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸¤ä¸ªé—®é¢˜ï¼š

- å­˜åœ¨è¯¯åˆ¤çš„æƒ…å†µã€‚
- å­˜åœ¨æ•°æ®æ›´æ–°é—®é¢˜ã€‚

å…ˆçœ‹çœ‹ä¸ºä»€ä¹ˆä¼šå­˜åœ¨è¯¯åˆ¤å‘¢ï¼Ÿ

ä¸Šé¢æˆ‘å·²ç»è¯´è¿‡ï¼Œåˆå§‹åŒ–æ•°æ®æ—¶ï¼Œé’ˆå¯¹æ¯ä¸ª key éƒ½æ˜¯é€šè¿‡å¤šæ¬¡ hash ç®—æ³•ï¼Œè®¡ç®—å‡ºä¸€äº›ä½ç½®ï¼Œç„¶åæŠŠè¿™äº›ä½ç½®ä¸Šçš„å…ƒç´ å€¼è®¾ç½®æˆ 1ã€‚

ä½†æˆ‘ä»¬éƒ½çŸ¥é“ hash ç®—æ³•æ˜¯ä¼šå‡ºç° hash å†²çªçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒçš„ keyï¼Œå¯èƒ½ä¼šè®¡ç®—å‡ºç›¸åŒçš„ä½ç½®ã€‚

![](../images/2024/12/aed7a9de-f98f-47ae-8d0a-cb3d56184d27.jpg)

ä¸Šå›¾ä¸­çš„ä¸‹æ ‡ä¸º 2 çš„ä½ç½®å°±å‡ºç°äº† hash å†²çªï¼Œkey1 å’Œ key2 è®¡ç®—å‡ºäº†ä¸€ä¸ªç›¸åŒçš„ä½ç½®ã€‚

å¦‚æœæœ‰å‡ åƒä¸‡æˆ–è€…ä¸Šäº¿çš„æ•°æ®ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„ hash å†²çªä¼šéå¸¸æ˜æ˜¾ã€‚

å¦‚æœæŸä¸ªç”¨æˆ· keyï¼Œç»è¿‡å¤šæ¬¡ hash è®¡ç®—å‡ºçš„ä½ç½®ï¼Œå…¶å…ƒç´ å€¼ï¼Œæ°å¥½éƒ½è¢«å…¶ä»–çš„ key åˆå§‹åŒ–æˆäº† 1ã€‚æ­¤æ—¶ï¼Œå°±å‡ºç°äº†è¯¯åˆ¤ï¼ŒåŸæœ¬è¿™ä¸ª key åœ¨æ•°æ®åº“ä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œä½†å¸ƒéš†è¿‡æ»¤å™¨ç¡®è®¤ä¸ºå­˜åœ¨ã€‚

> å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å‡ºæŸä¸ª key å­˜åœ¨ï¼Œå¯èƒ½å‡ºç°è¯¯åˆ¤ã€‚å¦‚æœåˆ¤æ–­æŸä¸ª key ä¸å­˜åœ¨ï¼Œåˆ™å®ƒåœ¨æ•°æ®åº“ä¸­ä¸€å®šä¸å­˜åœ¨ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤ç‡è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ã€‚å³ä½¿æœ‰å°‘éƒ¨åˆ†è¯¯åˆ¤çš„è¯·æ±‚ï¼Œç›´æ¥è®¿é—®äº†æ•°æ®åº“ï¼Œä½†å¦‚æœè®¿é—®é‡å¹¶ä¸å¤§ï¼Œå¯¹æ•°æ®åº“å½±å“ä¹Ÿä¸å¤§ã€‚

æ­¤å¤–ï¼Œå¦‚æœæƒ³å‡å°‘è¯¯åˆ¤ç‡ï¼Œå¯ä»¥é€‚å½“å¢åŠ  hash å‡½æ•°ï¼Œå›¾ä¸­ç”¨çš„ 3 æ¬¡ hashï¼Œå¯ä»¥å¢åŠ åˆ° 5 æ¬¡ã€‚

å…¶å®ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æœ€è‡´å‘½çš„é—®é¢˜æ˜¯ï¼šå¦‚æœæ•°æ®åº“ä¸­çš„æ•°æ®æ›´æ–°äº†ï¼Œéœ€è¦åŒæ­¥æ›´æ–°å¸ƒéš†è¿‡æ»¤å™¨ã€‚ä½†å®ƒè·Ÿæ•°æ®åº“æ˜¯ä¸¤ä¸ªæ•°æ®æºï¼Œå°±å¯èƒ½å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚

æ¯”å¦‚ï¼šæ•°æ®åº“ä¸­æ–°å¢äº†ä¸€ä¸ªç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·æ•°æ®éœ€è¦å®æ—¶åŒæ­¥åˆ°å¸ƒéš†è¿‡æ»¤ã€‚ä½†ç”±äºç½‘ç»œå¼‚å¸¸ï¼ŒåŒæ­¥å¤±è´¥äº†ã€‚

![](../images/2024/12/9864e5f4-e97e-489b-943b-339874a70af0.jpg)

è¿™æ—¶åˆšå¥½è¯¥ç”¨æˆ·è¯·æ±‚è¿‡æ¥äº†ï¼Œç”±äºå¸ƒéš†è¿‡æ»¤å™¨æ²¡æœ‰è¯¥ key çš„æ•°æ®ï¼Œæ‰€ä»¥ç›´æ¥æ‹’ç»äº†è¯¥è¯·æ±‚ã€‚ä½†è¿™ä¸ªæ˜¯æ­£å¸¸çš„ç”¨æˆ·ï¼Œä¹Ÿè¢«æ‹¦æˆªäº†ã€‚

å¾ˆæ˜¾ç„¶ï¼Œå¦‚æœå‡ºç°äº†è¿™ç§æ­£å¸¸ç”¨æˆ·è¢«æ‹¦æˆªäº†æƒ…å†µï¼Œæœ‰äº›ä¸šåŠ¡æ˜¯æ— æ³•å®¹å¿çš„ã€‚æ‰€ä»¥ï¼Œå¸ƒéš†è¿‡æ»¤å™¨è¦çœ‹å®é™…ä¸šåŠ¡åœºæ™¯å†å†³å®šæ˜¯å¦ä½¿ç”¨ï¼Œå®ƒå¸®æˆ‘ä»¬è§£å†³äº†ç¼“å­˜ç©¿é€é—®é¢˜ï¼Œä½†åŒæ—¶äº†å¸¦æ¥äº†æ–°çš„é—®é¢˜ã€‚


1.5 ç¼“å­˜ç©ºå€¼

ä¸Šé¢ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Œè™½è¯´å¯ä»¥è¿‡æ»¤æ‰å¾ˆå¤šä¸å­˜åœ¨çš„ç”¨æˆ· id è¯·æ±‚ã€‚ä½†å®ƒé™¤äº†å¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ä¹‹å¤–ï¼Œä¼šå¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š

- å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯æ€çš„æƒ…å†µï¼Œå¯èƒ½ä¼šæŠŠå°‘éƒ¨åˆ†æ­£å¸¸ç”¨æˆ·çš„è¯·æ±‚ä¹Ÿè¿‡æ»¤äº†ã€‚
- å¦‚æœç”¨æˆ·ä¿¡æ¯æœ‰å˜åŒ–ï¼Œéœ€è¦å®æ—¶åŒæ­¥åˆ°å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä¸ç„¶ä¼šæœ‰é—®é¢˜ã€‚

æ‰€ä»¥ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¾ˆå°‘ç”¨å¸ƒéš†è¿‡æ»¤å™¨è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜ã€‚å…¶å®ï¼Œè¿˜æœ‰å¦å¤–ä¸€ç§æ›´ç®€å•çš„æ–¹æ¡ˆï¼Œå³ï¼šç¼“å­˜ç©ºå€¼ã€‚

å½“æŸä¸ªç”¨æˆ· id åœ¨ç¼“å­˜ä¸­æŸ¥ä¸åˆ°ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹ŸæŸ¥ä¸åˆ°æ—¶ï¼Œä¹Ÿéœ€è¦å°†è¯¥ç”¨æˆ· id ç¼“å­˜èµ·æ¥ï¼Œåªä¸è¿‡å€¼æ˜¯ç©ºçš„ã€‚è¿™æ ·åé¢çš„è¯·æ±‚ï¼Œå†æ‹¿ç›¸åŒçš„ç”¨æˆ· id å‘èµ·è¯·æ±‚æ—¶ï¼Œå°±èƒ½ä»ç¼“å­˜ä¸­è·å–ç©ºæ•°æ®ï¼Œç›´æ¥è¿”å›äº†ï¼Œè€Œæ— éœ€å†å»æŸ¥ä¸€æ¬¡æ•°æ®åº“ã€‚

ä¼˜åŒ–ä¹‹åçš„æµç¨‹å›¾å¦‚ä¸‹ï¼š

![](../images/2024/12/4213f660-327e-4aeb-9aad-a4d0ac4d89df.jpg)

å…³é”®ç‚¹æ˜¯ä¸ç®¡ä»æ•°æ®åº“æœ‰æ²¡æœ‰æŸ¥åˆ°æ•°æ®ï¼Œéƒ½å°†ç»“æœæ”¾å…¥ç¼“å­˜ä¸­ï¼Œåªæ˜¯å¦‚æœæ²¡æœ‰æŸ¥åˆ°æ•°æ®ï¼Œç¼“å­˜ä¸­çš„å€¼æ˜¯ç©ºçš„ç½¢äº†ã€‚

#### 2ã€ç¼“å­˜å‡»ç©¿é—®é¢˜

2.1 ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨è®¿é—®çƒ­ç‚¹æ•°æ®æ—¶ã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬åœ¨æŸä¸ªå•†åŸè´­ä¹°æŸä¸ªçƒ­é—¨å•†å“ã€‚

ä¸ºäº†ä¿è¯è®¿é—®é€Ÿåº¦ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå•†åŸç³»ç»Ÿä¼šæŠŠå•†å“ä¿¡æ¯æ”¾åˆ°ç¼“å­˜ä¸­ã€‚ä½†å¦‚æœæŸä¸ªæ—¶åˆ»ï¼Œè¯¥å•†å“åˆ°äº†è¿‡æœŸæ—¶é—´å¤±æ•ˆäº†ã€‚

æ­¤æ—¶ï¼Œå¦‚æœæœ‰å¤§é‡çš„ç”¨æˆ·è¯·æ±‚åŒä¸€ä¸ªå•†å“ï¼Œä½†è¯¥å•†å“åœ¨ç¼“å­˜ä¸­å¤±æ•ˆäº†ï¼Œä¸€ä¸‹å­è¿™äº›ç”¨æˆ·è¯·æ±‚éƒ½ç›´æ¥æ€¼åˆ°æ•°æ®åº“ï¼Œå¯èƒ½ä¼šé€ æˆç¬é—´æ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼Œè€Œç›´æ¥æŒ‚æ‰ã€‚

æµç¨‹å›¾å¦‚ä¸‹ï¼š

![](../images/2024/12/11a098e3-db86-47b9-830d-71740e8efc58.jpg)

2.2 åŠ é”

æ•°æ®åº“å‹åŠ›è¿‡å¤§çš„æ ¹æºæ˜¯ï¼Œå› ä¸ºåŒä¸€æ—¶åˆ»å¤ªå¤šçš„è¯·æ±‚è®¿é—®äº†æ•°æ®åº“ã€‚

å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé™åˆ¶ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¯·æ±‚æ‰èƒ½è®¿é—®æŸä¸ª productId çš„æ•°æ®åº“å•†å“ä¿¡æ¯ï¼Œä¸å°±èƒ½è§£å†³é—®é¢˜äº†ï¼Ÿ

ç­”ï¼šæ²¡é”™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åŠ é”çš„æ–¹å¼ï¼Œå®ç°ä¸Šé¢çš„åŠŸèƒ½ã€‚

2.3 è‡ªåŠ¨ç»­æœŸ

å‡ºç°ç¼“å­˜å‡»ç©¿é—®é¢˜æ˜¯ç”±äº key è¿‡æœŸäº†å¯¼è‡´çš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ¢ä¸€ç§æ€è·¯ï¼Œåœ¨ key å¿«è¦è¿‡æœŸä¹‹å‰ï¼Œå°±è‡ªåŠ¨ç»™å®ƒç»­æœŸï¼Œä¸å°± OK äº†ï¼Ÿ

ç­”ï¼šæ²¡é”™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ job ç»™æŒ‡å®š key è‡ªåŠ¨ç»­æœŸã€‚

æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸ªåˆ†ç±»åŠŸèƒ½ï¼Œè®¾ç½®çš„ç¼“å­˜è¿‡æœŸæ—¶é—´æ˜¯ 30 åˆ†é’Ÿã€‚ä½†æœ‰ä¸ª job æ¯éš” 20 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œè‡ªåŠ¨æ›´æ–°ç¼“å­˜ï¼Œé‡æ–°è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 30 åˆ†é’Ÿã€‚

æ­¤å¤–ï¼Œåœ¨å¾ˆå¤šè¯·æ±‚ç¬¬ä¸‰æ–¹å¹³å°æ¥å£æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦å…ˆè°ƒç”¨ä¸€ä¸ªè·å– token çš„æ¥å£ï¼Œç„¶åç”¨è¿™ä¸ª token ä½œä¸ºå‚æ•°ï¼Œè¯·æ±‚çœŸæ­£çš„ä¸šåŠ¡æ¥å£ã€‚ä¸€èˆ¬è·å–åˆ°çš„ token æ˜¯æœ‰æœ‰æ•ˆæœŸçš„ï¼Œæ¯”å¦‚ 24 å°æ—¶ä¹‹åå¤±æ•ˆã€‚

å¦‚æœæˆ‘ä»¬æ¯æ¬¡è¯·æ±‚å¯¹æ–¹çš„ä¸šåŠ¡æ¥å£ï¼Œéƒ½è¦å…ˆè°ƒç”¨ä¸€æ¬¡è·å– token æ¥å£ï¼Œæ˜¾ç„¶æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”æ€§èƒ½ä¸å¤ªå¥½ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç¬¬ä¸€æ¬¡è·å–åˆ°çš„ token ç¼“å­˜èµ·æ¥ï¼Œè¯·æ±‚å¯¹æ–¹ä¸šåŠ¡æ¥å£æ—¶ä»ç¼“å­˜ä¸­è·å– tokenã€‚

åŒæ—¶ï¼Œæœ‰ä¸€ä¸ª job æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæ¯”å¦‚æ¯éš” 12 ä¸ªå°æ—¶è¯·æ±‚ä¸€æ¬¡è·å– token æ¥å£ï¼Œä¸åœåˆ·æ–° tokenï¼Œé‡æ–°è®¾ç½® token çš„è¿‡æœŸæ—¶é—´ã€‚

2.4 ç¼“å­˜ä¸å¤±æ•ˆ

æ­¤å¤–ï¼Œå¯¹äºå¾ˆå¤šçƒ­é—¨ keyï¼Œå…¶å®æ˜¯å¯ä»¥ä¸ç”¨è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè®©å…¶æ°¸ä¹…æœ‰æ•ˆçš„ã€‚

æ¯”å¦‚å‚ä¸ç§’æ€æ´»åŠ¨çš„çƒ­é—¨å•†å“ï¼Œç”±äºè¿™ç±»å•†å“ id å¹¶ä¸å¤šï¼Œåœ¨ç¼“å­˜ä¸­æˆ‘ä»¬å¯ä»¥ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚åœ¨ç§’æ€æ´»åŠ¨å¼€å§‹å‰ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªç¨‹åºæå‰ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºå•†å“çš„æ•°æ®ï¼Œç„¶ååŒæ­¥åˆ°ç¼“å­˜ä¸­ï¼Œæå‰åšé¢„çƒ­ã€‚ç­‰ç§’æ€æ´»åŠ¨ç»“æŸä¸€æ®µæ—¶é—´ä¹‹åï¼Œæˆ‘ä»¬å†æ‰‹åŠ¨åˆ é™¤è¿™äº›æ— ç”¨çš„ç¼“å­˜å³å¯ã€‚

#### 3ã€ç¼“å­˜é›ªå´©é—®é¢˜

3.1 ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ

ç¼“å­˜é›ªå´©æ˜¯ç¼“å­˜å‡»ç©¿çš„å‡çº§ç‰ˆï¼Œç¼“å­˜å‡»ç©¿è¯´çš„æ˜¯æŸä¸€ä¸ªçƒ­é—¨ key å¤±æ•ˆäº†ï¼Œè€Œç¼“å­˜é›ªå´©è¯´çš„æ˜¯æœ‰å¤šä¸ªçƒ­é—¨ key åŒæ—¶å¤±æ•ˆã€‚çœ‹èµ·æ¥ï¼Œå¦‚æœå‘ç”Ÿç¼“å­˜é›ªå´©ï¼Œé—®é¢˜æ›´ä¸¥é‡ã€‚

ç¼“å­˜é›ªå´©ç›®å‰æœ‰ä¸¤ç§ï¼š

- æœ‰å¤§é‡çš„çƒ­é—¨ç¼“å­˜ï¼ŒåŒæ—¶å¤±æ•ˆã€‚ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚ï¼Œè®¿é—®æ•°æ®åº“ã€‚è€Œæ•°æ®åº“å¾ˆæœ‰å¯èƒ½å› ä¸ºæ‰›ä¸ä½å‹åŠ›ï¼Œè€Œç›´æ¥æŒ‚æ‰ã€‚
- ç¼“å­˜æœåŠ¡å™¨ down æœºäº†ï¼Œå¯èƒ½æ˜¯æœºå™¨ç¡¬ä»¶é—®é¢˜ï¼Œæˆ–è€…æœºæˆ¿ç½‘ç»œé—®é¢˜ã€‚æ€»ä¹‹ï¼Œé€ æˆäº†æ•´ä¸ªç¼“å­˜çš„ä¸å¯ç”¨ã€‚

å½’æ ¹ç»“åº•éƒ½æ˜¯æœ‰å¤§é‡çš„è¯·æ±‚ï¼Œé€è¿‡ç¼“å­˜ï¼Œè€Œç›´æ¥è®¿é—®æ•°æ®åº“äº†ã€‚

![](../images/2024/12/7aa68b22-612e-4de8-9aa2-d2c2b02d6079.jpg)

3.2 è¿‡æœŸæ—¶é—´åŠ éšæœºæ•°

ä¸ºäº†è§£å†³ç¼“å­˜é›ªå´©é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å°½é‡é¿å…ç¼“å­˜åŒæ—¶å¤±æ•ˆçš„æƒ…å†µå‘ç”Ÿã€‚

è¿™å°±è¦æ±‚æˆ‘ä»¬ä¸è¦è®¾ç½®ç›¸åŒçš„è¿‡æœŸæ—¶é—´ã€‚å¯ä»¥åœ¨è®¾ç½®çš„è¿‡æœŸæ—¶é—´åŸºç¡€ä¸Šï¼Œå†åŠ ä¸ª 1~60 ç§’çš„éšæœºæ•°ã€‚

3.3 é«˜å¯ç”¨

é’ˆå¯¹ç¼“å­˜æœåŠ¡å™¨ down æœºçš„æƒ…å†µï¼Œåœ¨å‰æœŸåšç³»ç»Ÿè®¾è®¡æ—¶ï¼Œå¯ä»¥åšä¸€äº›é«˜å¯ç”¨æ¶æ„ã€‚

æ¯”å¦‚ï¼šå¦‚æœä½¿ç”¨äº† redisï¼Œå¯ä»¥ä½¿ç”¨å“¨å…µæ¨¡å¼ï¼Œæˆ–è€…é›†ç¾¤æ¨¡å¼ï¼Œé¿å…å‡ºç°å•èŠ‚ç‚¹æ•…éšœå¯¼è‡´æ•´ä¸ª redis æœåŠ¡ä¸å¯ç”¨çš„æƒ…å†µã€‚ä½¿ç”¨å“¨å…µæ¨¡å¼ä¹‹åï¼Œå½“æŸä¸ª master æœåŠ¡ä¸‹çº¿æ—¶ï¼Œè‡ªåŠ¨å°†è¯¥ master ä¸‹çš„æŸä¸ª slave æœåŠ¡å‡çº§ä¸º master æœåŠ¡ï¼Œæ›¿ä»£å·²ä¸‹çº¿çš„ master æœåŠ¡ç»§ç»­å¤„ç†è¯·æ±‚ã€‚

3.4 æœåŠ¡é™çº§

å¦‚æœåšäº†é«˜å¯ç”¨æ¶æ„ï¼Œredis æœåŠ¡è¿˜æ˜¯æŒ‚äº†ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

è¿™æ—¶å€™ï¼Œå°±éœ€è¦åšæœåŠ¡é™çº§äº†ã€‚æˆ‘ä»¬éœ€è¦é…ç½®ä¸€äº›é»˜è®¤çš„å…œåº•æ•°æ®ã€‚ç¨‹åºä¸­æœ‰ä¸ªå…¨å±€å¼€å…³ï¼Œæ¯”å¦‚æœ‰ 10 ä¸ªè¯·æ±‚åœ¨æœ€è¿‘ä¸€åˆ†é’Ÿå†…ï¼Œä» redis ä¸­è·å–æ•°æ®å¤±è´¥ï¼Œåˆ™å…¨å±€å¼€å…³æ‰“å¼€ã€‚åé¢çš„æ–°è¯·æ±‚ï¼Œå°±ç›´æ¥ä»é…ç½®ä¸­å¿ƒä¸­è·å–é»˜è®¤çš„æ•°æ®ã€‚

![](../images/2024/12/00adc41d-3ff4-47c8-b319-e407d2cb33ac.jpg)

å½“ç„¶ï¼Œè¿˜éœ€è¦æœ‰ä¸ª jobï¼Œæ¯éš”ä¸€å®šæ—¶é—´å»ä» redis ä¸­è·å–æ•°æ®ï¼Œå¦‚æœåœ¨æœ€è¿‘ä¸€åˆ†é’Ÿå†…å¯ä»¥è·å–åˆ°ä¸¤æ¬¡æ•°æ®ï¼ˆè¿™ä¸ªå‚æ•°å¯ä»¥è‡ªå·±å®šï¼‰ï¼Œåˆ™æŠŠå…¨å±€å¼€å…³å…³é—­ã€‚åé¢æ¥çš„è¯·æ±‚ï¼Œåˆå¯ä»¥æ­£å¸¸ä» redis ä¸­è·å–æ•°æ®äº†ã€‚

éœ€è¦ç‰¹åˆ«è¯´ä¸€å¥ï¼Œè¯¥æ–¹æ¡ˆå¹¶éæ‰€æœ‰çš„åœºæ™¯éƒ½é€‚ç”¨ï¼Œéœ€è¦æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯å†³å®šã€‚

### 3. [C++ è™šå‡½æ•°è¡¨å‰–æ](https://zhuanlan.zhihu.com/p/75172640)

#### ä¸€ã€æ¦‚è¿°

ä¸ºäº†å®ç° C++ çš„å¤šæ€ï¼ŒC++ ä½¿ç”¨äº†ä¸€ç§åŠ¨æ€ç»‘å®šçš„æŠ€æœ¯ã€‚è¿™ä¸ªæŠ€æœ¯çš„æ ¸å¿ƒæ˜¯è™šå‡½æ•°è¡¨ï¼ˆä¸‹æ–‡ç®€ç§°è™šè¡¨ï¼‰ã€‚æœ¬æ–‡ä»‹ç»è™šå‡½æ•°è¡¨æ˜¯å¦‚ä½•å®ç°åŠ¨æ€ç»‘å®šçš„ã€‚

#### äºŒã€ç±»çš„è™šè¡¨

æ¯ä¸ªåŒ…å«äº†è™šå‡½æ•°çš„ç±»éƒ½åŒ…å«ä¸€ä¸ªè™šè¡¨ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œå½“ä¸€ä¸ªç±»ï¼ˆAï¼‰ç»§æ‰¿å¦ä¸€ä¸ªç±»ï¼ˆBï¼‰æ—¶ï¼Œç±» A ä¼šç»§æ‰¿ç±» B çš„å‡½æ•°çš„è°ƒç”¨æƒã€‚æ‰€ä»¥å¦‚æœä¸€ä¸ªåŸºç±»åŒ…å«äº†è™šå‡½æ•°ï¼Œé‚£ä¹ˆå…¶ç»§æ‰¿ç±»ä¹Ÿå¯è°ƒç”¨è¿™äº›è™šå‡½æ•°ï¼Œæ¢å¥è¯è¯´ï¼Œä¸€ä¸ªç±»ç»§æ‰¿äº†åŒ…å«è™šå‡½æ•°çš„åŸºç±»ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»ä¹Ÿæ‹¥æœ‰è‡ªå·±çš„è™šè¡¨ã€‚

æˆ‘ä»¬æ¥çœ‹ä»¥ä¸‹çš„ä»£ç ã€‚ç±» A åŒ…å«è™šå‡½æ•° vfunc1ï¼Œvfunc2ï¼Œç”±äºç±» A åŒ…å«è™šå‡½æ•°ï¼Œæ•…ç±» A æ‹¥æœ‰ä¸€ä¸ªè™šè¡¨ã€‚

```C++
class A {
public:
    virtual void vfunc1();
    virtual void vfunc2();
    void func1();
    void func2();
private:
    int m_data1, m_data2;
};
```

ç±» A çš„è™šè¡¨å¦‚å›¾ 1 æ‰€ç¤ºã€‚

![](../images/2024/12/v2-e864f4fe6a480b3230a5c9aebd7df996_1440w.jpg)

å›¾ 1ï¼šç±» A çš„è™šè¡¨ç¤ºæ„å›¾

è™šè¡¨æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œå…¶å…ƒç´ æ˜¯è™šå‡½æ•°çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªè™šå‡½æ•°çš„å‡½æ•°æŒ‡é’ˆã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œæ™®é€šçš„å‡½æ•°å³éè™šå‡½æ•°ï¼Œå…¶è°ƒç”¨å¹¶ä¸éœ€è¦ç»è¿‡è™šè¡¨ï¼Œæ‰€ä»¥è™šè¡¨çš„å…ƒç´ å¹¶ä¸åŒ…æ‹¬æ™®é€šå‡½æ•°çš„å‡½æ•°æŒ‡é’ˆã€‚
è™šè¡¨å†…çš„æ¡ç›®ï¼Œå³è™šå‡½æ•°æŒ‡é’ˆçš„èµ‹å€¼å‘ç”Ÿåœ¨ç¼–è¯‘å™¨çš„ç¼–è¯‘é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä»£ç çš„ç¼–è¯‘é˜¶æ®µï¼Œè™šè¡¨å°±å¯ä»¥æ„é€ å‡ºæ¥äº†ã€‚

#### ä¸‰ã€è™šè¡¨æŒ‡é’ˆ

è™šè¡¨æ˜¯å±äºç±»çš„ï¼Œè€Œä¸æ˜¯å±äºæŸä¸ªå…·ä½“çš„å¯¹è±¡ï¼Œä¸€ä¸ªç±»åªéœ€è¦ä¸€ä¸ªè™šè¡¨å³å¯ã€‚åŒä¸€ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä½¿ç”¨åŒä¸€ä¸ªè™šè¡¨ã€‚

ä¸ºäº†æŒ‡å®šå¯¹è±¡çš„è™šè¡¨ï¼Œå¯¹è±¡å†…éƒ¨åŒ…å«ä¸€ä¸ªè™šè¡¨çš„æŒ‡é’ˆï¼Œæ¥æŒ‡å‘è‡ªå·±æ‰€ä½¿ç”¨çš„è™šè¡¨ã€‚ä¸ºäº†è®©æ¯ä¸ªåŒ…å«è™šè¡¨çš„ç±»çš„å¯¹è±¡éƒ½æ‹¥æœ‰ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆï¼Œç¼–è¯‘å™¨åœ¨ç±»ä¸­æ·»åŠ äº†ä¸€ä¸ªæŒ‡é’ˆï¼Œ`*__vptr`ï¼Œç”¨æ¥æŒ‡å‘è™šè¡¨ã€‚è¿™æ ·ï¼Œå½“ç±»çš„å¯¹è±¡åœ¨åˆ›å»ºæ—¶ä¾¿æ‹¥æœ‰äº†è¿™ä¸ªæŒ‡é’ˆï¼Œä¸”è¿™ä¸ªæŒ‡é’ˆçš„å€¼ä¼šè‡ªåŠ¨è¢«è®¾ç½®ä¸ºæŒ‡å‘ç±»çš„è™šè¡¨ã€‚

![](../images/2024/12/v2-0fceb07713e411d48b4c361452129585_r.jpg)

å›¾ 2ï¼šå¯¹è±¡ä¸å®ƒçš„è™šè¡¨

ä¸Šé¢æŒ‡å‡ºï¼Œä¸€ä¸ªç»§æ‰¿ç±»çš„åŸºç±»å¦‚æœåŒ…å«è™šå‡½æ•°ï¼Œé‚£ä¸ªè¿™ä¸ªç»§æ‰¿ç±»ä¹Ÿæœ‰æ‹¥æœ‰è‡ªå·±çš„è™šè¡¨ï¼Œæ•…è¿™ä¸ªç»§æ‰¿ç±»çš„å¯¹è±¡ä¹ŸåŒ…å«ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘å®ƒçš„è™šè¡¨ã€‚

#### å››ã€åŠ¨æ€ç»‘å®š

è¯´åˆ°è¿™é‡Œï¼Œå¤§å®¶ä¸€å®šä¼šå¥½å¥‡ C++ æ˜¯å¦‚ä½•åˆ©ç”¨è™šè¡¨å’Œè™šè¡¨æŒ‡é’ˆæ¥å®ç°åŠ¨æ€ç»‘å®šçš„ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸‹é¢çš„ä»£ç ã€‚

```C++
class A {
public:
    virtual void vfunc1();
    virtual void vfunc2();
    void func1();
    void func2();
private:
    int m_data1, m_data2;
};
class B : public A {
public:
    virtual void vfunc1();
    void func1();
private:
    int m_data3;
};
class C: public B {
public:
    virtual void vfunc2();
    void func2();
private:
    int m_data1, m_data4;
};
```

ç±» A æ˜¯åŸºç±»ï¼Œç±» B ç»§æ‰¿ç±» Aï¼Œç±» C åˆç»§æ‰¿ç±» Bã€‚ç±» Aï¼Œç±» Bï¼Œç±» Cï¼Œå…¶å¯¹è±¡æ¨¡å‹å¦‚ä¸‹å›¾ 3 æ‰€ç¤ºã€‚

![](../images/2024/12/v2-dfe4aefdee7e06cf3151b57492ed42a2_r.jpg)

å›¾ 3ï¼šç±» Aï¼Œç±» Bï¼Œç±» C çš„å¯¹è±¡æ¨¡å‹

ç”±äºè¿™ä¸‰ä¸ªç±»éƒ½æœ‰è™šå‡½æ•°ï¼Œæ•…ç¼–è¯‘å™¨ä¸ºæ¯ä¸ªç±»éƒ½åˆ›å»ºäº†ä¸€ä¸ªè™šè¡¨ï¼Œå³ç±» A çš„è™šè¡¨ï¼ˆA vtblï¼‰ï¼Œç±» B çš„è™šè¡¨ï¼ˆB vtblï¼‰ï¼Œç±» C çš„è™šè¡¨ï¼ˆC vtblï¼‰ã€‚ç±» Aï¼Œç±» Bï¼Œç±» C çš„å¯¹è±¡éƒ½æ‹¥æœ‰ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆï¼Œ`*__vptr`ï¼Œç”¨æ¥æŒ‡å‘è‡ªå·±æ‰€å±ç±»çš„è™šè¡¨ã€‚

ç±» A åŒ…æ‹¬ä¸¤ä¸ªè™šå‡½æ•°ï¼Œæ•… A vtbl åŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘ `A::vfunc1()` å’Œ `A::vfunc2()`ã€‚

ç±» B ç»§æ‰¿äºç±» Aï¼Œæ•…ç±» B å¯ä»¥è°ƒç”¨ç±» A çš„å‡½æ•°ï¼Œä½†ç”±äºç±» B é‡å†™äº† `B::vfunc1()` å‡½æ•°ï¼Œæ•… B vtbl çš„ä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ `B::vfunc1()` å’Œ `A::vfunc2()`ã€‚

ç±» C ç»§æ‰¿äºç±» Bï¼Œæ•…ç±» C å¯ä»¥è°ƒç”¨ç±» B çš„å‡½æ•°ï¼Œä½†ç”±äºç±» C é‡å†™äº† `C::vfunc2()` å‡½æ•°ï¼Œæ•… C vtbl çš„ä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ `B::vfunc1()` ï¼ˆæŒ‡å‘ç»§æ‰¿çš„æœ€è¿‘çš„ä¸€ä¸ªç±»çš„å‡½æ•°ï¼‰å’Œ `C::vfunc2()`ã€‚

è™½ç„¶å›¾ 3 çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œä½†æ˜¯åªè¦æŠ“ä½ â€œå¯¹è±¡çš„è™šè¡¨æŒ‡é’ˆç”¨æ¥æŒ‡å‘è‡ªå·±æ‰€å±ç±»çš„è™šè¡¨ï¼Œè™šè¡¨ä¸­çš„æŒ‡é’ˆä¼šæŒ‡å‘å…¶ç»§æ‰¿çš„æœ€è¿‘çš„ä¸€ä¸ªç±»çš„è™šå‡½æ•°â€ è¿™ä¸ªç‰¹ç‚¹ï¼Œä¾¿å¯ä»¥å¿«é€Ÿå°†è¿™å‡ ä¸ªç±»çš„å¯¹è±¡æ¨¡å‹åœ¨è‡ªå·±çš„è„‘æµ·ä¸­æç»˜å‡ºæ¥ã€‚

éè™šå‡½æ•°çš„è°ƒç”¨ä¸ç”¨ç»è¿‡è™šè¡¨ï¼Œæ•…ä¸éœ€è¦è™šè¡¨ä¸­çš„æŒ‡é’ˆæŒ‡å‘è¿™äº›å‡½æ•°ã€‚

å‡è®¾æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç±» B çš„å¯¹è±¡bObjectã€‚ç”±äºbObjectæ˜¯ç±» B çš„ä¸€ä¸ªå¯¹è±¡ï¼Œæ•…bObjectåŒ…å«ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆï¼ŒæŒ‡å‘ç±» B çš„è™šè¡¨ã€‚

```C++
int main() {
    B bObject;
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªç±» A çš„æŒ‡é’ˆ p æ¥æŒ‡å‘å¯¹è±¡bObjectã€‚è™½ç„¶pæ˜¯åŸºç±»çš„æŒ‡é’ˆåªèƒ½æŒ‡å‘åŸºç±»çš„éƒ¨åˆ†ï¼Œä½†æ˜¯è™šè¡¨æŒ‡é’ˆäº¦å±äºåŸºç±»éƒ¨åˆ†ï¼Œæ‰€ä»¥på¯ä»¥è®¿é—®åˆ°å¯¹è±¡bObjectçš„è™šè¡¨æŒ‡é’ˆã€‚bObjectçš„è™šè¡¨æŒ‡é’ˆæŒ‡å‘ç±» B çš„è™šè¡¨ï¼Œæ‰€ä»¥på¯ä»¥è®¿é—®åˆ° B vtblã€‚å¦‚å›¾ 3 æ‰€ç¤ºã€‚

```C++
int main() {
    B bObject;
    A *p = & bObject;
}
```

å½“æˆ‘ä»¬ä½¿ç”¨pæ¥è°ƒç”¨vfunc1()å‡½æ•°æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆç°è±¡ï¼Ÿ

```C++
int main() {
    B bObject;
    A *p = & bObject;
    p->vfunc1();
}
```

ç¨‹åºåœ¨æ‰§è¡Œ `p->vfunc1()` æ—¶ï¼Œä¼šå‘ç°pæ˜¯ä¸ªæŒ‡é’ˆï¼Œä¸”è°ƒç”¨çš„å‡½æ•°æ˜¯è™šå‡½æ•°ï¼Œæ¥ä¸‹æ¥ä¾¿ä¼šè¿›è¡Œä»¥ä¸‹çš„æ­¥éª¤ã€‚

é¦–å…ˆï¼Œæ ¹æ®è™šè¡¨æŒ‡é’ˆ `p->__vptr` æ¥è®¿é—®å¯¹è±¡bObjectå¯¹åº”çš„è™šè¡¨ã€‚è™½ç„¶æŒ‡é’ˆpæ˜¯åŸºç±» `A*` ç±»å‹ï¼Œä½†æ˜¯ `*__vptr` ä¹Ÿæ˜¯åŸºç±»çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ `p->__vptr` å¯ä»¥è®¿é—®åˆ°å¯¹è±¡å¯¹åº”çš„è™šè¡¨ã€‚

ç„¶åï¼Œåœ¨è™šè¡¨ä¸­æŸ¥æ‰¾æ‰€è°ƒç”¨çš„å‡½æ•°å¯¹åº”çš„æ¡ç›®ã€‚ç”±äºè™šè¡¨åœ¨ç¼–è¯‘é˜¶æ®µå°±å¯ä»¥æ„é€ å‡ºæ¥äº†ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®æ‰€è°ƒç”¨çš„å‡½æ•°å®šä½åˆ°è™šè¡¨ä¸­çš„å¯¹åº”æ¡ç›®ã€‚å¯¹äº `p->vfunc1()` çš„è°ƒç”¨ï¼ŒB vtbl çš„ç¬¬ä¸€é¡¹å³æ˜¯ vfunc1 å¯¹åº”çš„æ¡ç›®ã€‚

æœ€åï¼Œæ ¹æ®è™šè¡¨ä¸­æ‰¾åˆ°çš„å‡½æ•°æŒ‡é’ˆï¼Œè°ƒç”¨å‡½æ•°ã€‚ä»å›¾ 3 å¯ä»¥çœ‹åˆ°ï¼ŒB vtbl çš„ç¬¬ä¸€é¡¹æŒ‡å‘ `B::vfunc1()`ï¼Œæ‰€ä»¥ `p->vfunc1()` å®è´¨ä¼šè°ƒç”¨ `B::vfunc1()` å‡½æ•°ã€‚

å¦‚æœpæŒ‡å‘ç±» A çš„å¯¹è±¡ï¼Œæƒ…å†µåˆæ˜¯æ€ä¹ˆæ ·ï¼Ÿ

```C++
int main() {
    A aObject;
    A *p = &aObject;
    p->vfunc1();
}
```

å½“aObjectåœ¨åˆ›å»ºæ—¶ï¼Œå®ƒçš„è™šè¡¨æŒ‡é’ˆ `__vptr` å·²è®¾ç½®ä¸ºæŒ‡å‘ A vtblï¼Œè¿™æ · `p->__vptr` å°±æŒ‡å‘ A vtblã€‚vfunc1åœ¨ A vtbl å¯¹åº”åœ¨æ¡ç›®æŒ‡å‘äº† `A::vfunc1()` å‡½æ•°ï¼Œæ‰€ä»¥ `p->vfunc1()` å®è´¨ä¼šè°ƒç”¨ `A::vfunc1()` å‡½æ•°ã€‚

å¯ä»¥æŠŠä»¥ä¸Šä¸‰ä¸ªè°ƒç”¨å‡½æ•°çš„æ­¥éª¤ç”¨ä»¥ä¸‹è¡¨è¾¾å¼æ¥è¡¨ç¤ºï¼š

```C++
(*(p->__vptr)[n])(p)
```

å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ä½¿ç”¨è¿™äº›è™šå‡½æ•°è¡¨ï¼Œå³ä½¿ä½¿ç”¨çš„æ˜¯åŸºç±»çš„æŒ‡é’ˆæ¥è°ƒç”¨å‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°æ­£ç¡®è°ƒç”¨è¿è¡Œä¸­å®é™…å¯¹è±¡çš„è™šå‡½æ•°ã€‚

æˆ‘ä»¬æŠŠç»è¿‡è™šè¡¨è°ƒç”¨è™šå‡½æ•°çš„è¿‡ç¨‹ç§°ä¸ºåŠ¨æ€ç»‘å®šï¼Œå…¶è¡¨ç°å‡ºæ¥çš„ç°è±¡ç§°ä¸ºè¿è¡Œæ—¶å¤šæ€ã€‚åŠ¨æ€ç»‘å®šåŒºåˆ«äºä¼ ç»Ÿçš„å‡½æ•°è°ƒç”¨ï¼Œä¼ ç»Ÿçš„å‡½æ•°è°ƒç”¨æˆ‘ä»¬ç§°ä¹‹ä¸ºé™æ€ç»‘å®šï¼Œå³å‡½æ•°çš„è°ƒç”¨åœ¨ç¼–è¯‘é˜¶æ®µå°±å¯ä»¥ç¡®å®šä¸‹æ¥äº†ã€‚

é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™ä¼šæ‰§è¡Œå‡½æ•°çš„åŠ¨æ€ç»‘å®šï¼Ÿè¿™éœ€è¦ç¬¦åˆä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ã€‚

- é€šè¿‡æŒ‡é’ˆæ¥è°ƒç”¨å‡½æ•°
- æŒ‡é’ˆ upcast å‘ä¸Šè½¬å‹ï¼ˆç»§æ‰¿ç±»å‘åŸºç±»çš„è½¬æ¢ç§°ä¸º upcastï¼Œå…³äºä»€ä¹ˆæ˜¯ upcastï¼Œå¯ä»¥å‚è€ƒæœ¬æ–‡çš„å‚è€ƒèµ„æ–™ï¼‰
- è°ƒç”¨çš„æ˜¯è™šå‡½æ•°

å¦‚æœä¸€ä¸ªå‡½æ•°è°ƒç”¨ç¬¦åˆä»¥ä¸Šä¸‰ä¸ªæ¡ä»¶ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠŠè¯¥å‡½æ•°è°ƒç”¨ç¼–è¯‘æˆåŠ¨æ€ç»‘å®šï¼Œå…¶å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹èµ°çš„æ˜¯ä¸Šè¿°é€šè¿‡è™šè¡¨çš„æœºåˆ¶ã€‚

#### äº”ã€æ€»ç»“

å°è£…ï¼Œç»§æ‰¿ï¼Œå¤šæ€æ˜¯é¢å‘å¯¹è±¡è®¾è®¡çš„ä¸‰ä¸ªç‰¹å¾ï¼Œè€Œå¤šæ€å¯ä»¥è¯´æ˜¯é¢å‘å¯¹è±¡è®¾è®¡çš„å…³é”®ã€‚C++ é€šè¿‡è™šå‡½æ•°è¡¨ï¼Œå®ç°äº†è™šå‡½æ•°ä¸å¯¹è±¡çš„åŠ¨æ€ç»‘å®šï¼Œä»è€Œæ„å»ºäº† C++ é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡çš„åŸºçŸ³ã€‚

#### å‚è€ƒèµ„æ–™

- ã€ŠC++ Primerã€‹ç¬¬ä¸‰ç‰ˆï¼Œä¸­æ–‡ç‰ˆï¼Œæ½˜çˆ±æ°‘ç­‰è¯‘
- http://www.learncpp.com/cpp-tutorial/125-the-virtual-table/
- ä¾¯æ·ã€ŠC++ æœ€ä½³ç¼–ç¨‹å®è·µã€‹è§†é¢‘ï¼Œæå®¢ç­ï¼Œ2015
- Upcasting and Downcasting, http://www.bogotobogo.com/cplusplus/upcasting_downcasting.php

## tip [ğŸ”](#weekly-92)

## share [ğŸ”](#weekly-92)

### 1. [å—é£æ³•åˆ™](https://wiki.mbalib.com/wiki/%E5%8D%97%E9%A3%8E%E6%B3%95%E5%88%99)

â€œå—é£â€æ³•åˆ™ï¼Œæºäºæ³•å›½ä½œå®¶æ‹‰å°ä¸¹å†™è¿‡çš„ä¸€åˆ™å¯“è¨€ï¼šåŒ—é£å’Œå—é£æ¯”å¨åŠ›ï¼Œçœ‹è°èƒ½æŠŠè¡Œäººèº«ä¸Šçš„å¤§è¡£è„±æ‰ã€‚åŒ—é£é¦–å…ˆæ¥ä¸€ä¸ªå†·é£å‡›å†½å¯’å†·åˆºéª¨ï¼Œç»“æœè¡ŒäººæŠŠå¤§è¡£è£¹å¾—ç´§ç´§çš„ã€‚å—é£åˆ™å¾å¾å¹åŠ¨ï¼Œé¡¿æ—¶é£å’Œæ—¥ä¸½ï¼Œè¡Œäººå› ä¸ºè§‰å¾—æ˜¥æ„ä¸Šèº«ï¼Œå§‹è€Œè§£å¼€çº½æ‰£ï¼Œç»§è€Œè„±æ‰å¤§è¡£ï¼Œå—é£è·å¾—äº†èƒœåˆ©ã€‚

â€œå—é£â€æ³•åˆ™ä¹Ÿå«åšâ€œæ¸©æš–â€æ³•åˆ™ï¼Œå®ƒæ¥æºäºæ³•å›½ä½œå®¶æ‹‰â€¢å°ä¸¹å†™çš„è¿™åˆ™å¯“è¨€ã€‚å®ƒå‘Šè¯‰æˆ‘ä»¬ï¼šæ¸©æš–èƒœäºä¸¥å¯’ã€‚è¿ç”¨åˆ°ç®¡ç†å®è·µä¸­ï¼Œå—é£æ³•åˆ™è¦æ±‚ç®¡ç†è€…è¦å°Šé‡å’Œå…³å¿ƒä¸‹å±ï¼Œæ—¶åˆ»ä»¥ä¸‹å±ä¸ºæœ¬ï¼Œå¤šç‚¹â€œäººæƒ…å‘³â€ï¼Œå¤šæ³¨æ„è§£å†³ä¸‹å±æ—¥å¸¸ç”Ÿæ´»ä¸­çš„å®é™…å›°éš¾ï¼Œä½¿ä¸‹å±çœŸæ­£æ„Ÿå—åˆ°ç®¡ç†è€…ç»™äºˆçš„æ¸©æš–ã€‚è¿™æ ·ï¼Œä¸‹å±å‡ºäºæ„Ÿæ¿€å°±ä¼šæ›´åŠ åŠªåŠ›ç§¯æåœ°ä¸ºä¼ä¸šå·¥ä½œï¼Œç»´æŠ¤ä¼ä¸šåˆ©ç›Šã€‚

å¤è¯­äº‘ï¼šå¾—æ°‘å¿ƒè€…å¾—å¤©ä¸‹ï¼åªæœ‰çœŸæ­£ä¿˜è·äº†å‘˜å·¥çš„å¿ƒçµï¼Œå‘˜å·¥æ‰ä¼šä¸ºä¼ä¸šçš„å‘å±•æ­»å¿ƒå¡Œåœ°åœ°å·¥ä½œã€‚åœ¨ä¼ä¸šç®¡ç†ä¸­å¤šç‚¹äººæƒ…å‘³ï¼Œå°‘äº›é“œè‡­å‘³ï¼Œæœ‰åŠ©äºåŸ¹å…»å‘˜å·¥å¯¹ä¼ä¸šçš„è®¤åŒæ„Ÿå’Œå¿ è¯šåº¦ã€‚æœ‰äº†è¿™äº›ï¼Œä¼ä¸šåœ¨ç«äº‰ä¸­å°±èƒ½æ— å¾€è€Œä¸èƒœã€‚

ä¿—è¯è¯´ï¼šâ€œè‰¯è¨€ä¸€å¥ä¸‰å†¬æš–ï¼Œæ¶è¯­ä¼¤äººå…­æœˆå¯’â€ï¼Œæœ‰æ—¶å€™æ€€æŸ”æ”¿ç­–èƒœäºæ¿€çƒˆå¯¹æŠ—ã€‚ä¼ä¸šç»è¥çš„æ ¸å¿ƒæ˜¯å®¢æˆ·ï¼ŒæŠŠå®¢æˆ·éœ€è¦æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œç”¨å’Œç…¦çš„æ˜¥é£å¹åŒ–å®¢æˆ·å¿ƒä¸­çš„åšå†°ï¼Œæ‰èƒ½å¾—åˆ°å¯¹æ–¹çš„ä¿¡ä»»å’Œæ”¯æŒã€‚

[readme](../README.md) | [previous](202412W1.md) | [next](202412W3.md)
