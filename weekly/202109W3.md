> @Author  : Lewis Tian (taseikyo@gmail.com)
>
> @Link    : github.com/taseikyo
>
> @Range   : 2021-09-17 - 2021-09-17

# Weekly #46

[readme](../README.md) | [previous](202109W2.md) | [next](202109W4.md)

## Table of Contents

- [algorithm](#algorithm-)
- [review](#review-)
    - ç»å¯¹å€¼è®¡ç®—å¹¶ä¸ç®€å•ï¼ˆè‹±æ–‡ï¼‰
- [tip](#tip-)
    - MDvideo: Markdown To Video
- [share](#share-)

## algorithm [ğŸ”](#weekly-46)

## review [ğŸ”](#weekly-46)

### 1. [ç»å¯¹å€¼è®¡ç®—å¹¶ä¸ç®€å•](https://habr.com/en/post/574082)

è®¡ç®—ä¸€ä¸ªæ•°çš„ç»å¯¹å€¼çš„é—®é¢˜æ˜¯å®Œå…¨å¾®ä¸è¶³é“çš„ã€‚å¦‚æœæ•°å­—æ˜¯è´Ÿçš„ï¼Œæ”¹å˜ç¬¦å·ã€‚å¦åˆ™ï¼Œå°±è®©å®ƒä¿æŒåŸæ ·ã€‚

åœ¨ Java ä¸­ï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```Java
public static double abs(double value) {
  if (value < 0) {
    return -value;
  }
  return value;
}
```

åœ¨ [IEEE-754](https://en.wikipedia.org/wiki/IEEE_754-2008) æ ‡å‡†ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨ Java ä¸­ï¼Œæœ‰ä¸¤ä¸ªé›¶: `+0.0` å’Œ `-0.0`ï¼ŒæŠŠ 1.0 é™¤ä»¥ `+0.0` å’Œ `-0.0`ï¼Œä½ ä¼šå¾—åˆ°å®Œå…¨ä¸åŒçš„ç­”æ¡ˆ: `+Infinity` å’Œ ï¼Œåœ¨æ¯”è¾ƒæ“ä½œä¸­ï¼Œ`+0.0` å’Œ `-0.0` æ˜¯æ— æ³•åŒºåˆ†çš„ã€‚å› æ­¤ï¼Œä¸Šé¢çš„å®ç° `-0.0` çš„è½¬æ­£ï¼š

```Java
double x = -0.0;
if (1 / abs(x) < 0) {
  System.out.println("oops");
}
```

ç›´æ¥æ”¹ä¸º `if (value < 0 | | value =-0.0)` æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸º `+0.0 = -0.0`

ä¸ºäº†å¯é åœ°åŒºåˆ†ä»–ä»¬ä¿©ï¼Œæœ‰ä¸€ä¸ª `double.compare` æ–¹æ³•ï¼š

```Java
public static double abs(double value) {
  if (value < 0 || Double.compare(value, -0.0) == 0) {
    return -value;
  }
  return value;
}
```

ä¸Šè¿°æ–¹æ³•è™½ç„¶æœ‰æ•ˆï¼Œä½†æ˜¯å¯¹äºè¿™æ ·ä¸€ä¸ªç®€å•çš„æ“ä½œå˜å¾—éå¸¸æ…¢

å®ç° `double.compare` å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ã€‚å¯¹äºæ­£æ•°éœ€è¦ä¸¤æ¬¡é¢å¤–çš„æ¯”è¾ƒï¼Œå¯¹äº `-0.0` éœ€è¦ä¸‰æ¬¡æ¯”è¾ƒï¼Œå¯¹äº `+0.0` éœ€è¦å¤šè¾¾å››æ¬¡æ¯”è¾ƒã€‚


å¦‚æœçœ‹ä¸‹ [`double.compare` çš„æºç ](https://github.com/openjdk/jdk/blob/36e2ddad4d2ef3ce27475af6244d0246a8315c0c/src/java.base/share/classes/java/lang/Double.java#L1117)ï¼Œå¯ä»¥çœ‹åˆ°å®é™…ä¸Šæˆ‘ä»¬ä»…éœ€è¦ä¸€ä¸ª `doubleToLongBits`ï¼Œæ­¤æ–¹æ³•å°† `double` ç±»å‹çš„äºŒè¿›åˆ¶è¡¨ç¤ºé‡æ–°è§£é‡Šä¸º `long` ç±»å‹ï¼š

```Java
private static final long MINUS_ZERO_LONG_BITS =
  Double.doubleToLongBits(-0.0);

public static double abs(double value) {
  if (value < 0 ||
      Double.doubleToLongBits(value) == MINUS_ZERO_LONG_BITS) {
    return -value;
  }
  return value;
}
```

`doubleToLongBits` å°† NaN è§„èŒƒåŒ–ï¼ˆcanonicalizesï¼‰äº†ï¼Œ`doubleToLongBits` å°† NaN è½¬åŒ–ä¸º `0x7ff8000000000l`ï¼Œå¾ˆæ˜¾ç„¶åˆå¤šäº†æ¡ä»¶åˆ¤æ–­ã€‚

è¿˜æœ‰å¦ä¸€ç§æ–¹æ³• `doubleToRawLongBits`ã€‚å®ƒä¸æ‰§è¡Œä»»ä½•æ™ºèƒ½çš„ NaN è½¬æ¢ï¼Œåªæ˜¯è¿”å›å®Œå…¨ç›¸åŒçš„ä½è¡¨ç¤ºï¼š

```Java
private static final long MINUS_ZERO_LONG_BITS =
  Double.doubleToRawLongBits(-0.0);

public static double abs(double value) {
  if (value < 0 ||
      Double.doubleToRawLongBits(value) == MINUS_ZERO_LONG_BITS) {
    return -value;
  }
  return value;
}
```

JIT ç¼–è¯‘å™¨å¯ä»¥å®Œå…¨åˆ é™¤ doubleToRawLongBits æ–¹æ³•è°ƒç”¨ï¼Œå› ä¸ºè¿™åªæ˜¯é‡æ–°è§£é‡Š CPU å¯„å­˜å™¨ä¸­å­˜å‚¨çš„æ¯”ç‰¹é›†çš„é—®é¢˜ï¼Œè¿™æ · Java æ•°æ®ç±»å‹å°±ä¼šä¸€è‡´ã€‚

ä½†æ˜¯æ¯”ç‰¹æœ¬èº«ä¿æŒä¸å˜ï¼ŒCPU é€šå¸¸ä¸å…³å¿ƒæ•°æ®ç±»å‹ã€‚è™½ç„¶æœ‰ä¼ è¨€è¯´ï¼Œè¿™ä¸ªç”µè¯ä»ç„¶å¯èƒ½å¯¼è‡´ä»ä¸€ä¸ªæµ®ç‚¹å¯„å­˜å™¨è½¬ç§»åˆ°ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒè¿˜æ˜¯éå¸¸å¿«ã€‚

æˆ‘ä»¬èƒ½åšå¾—æ›´å°‘å—ï¼Ÿ

äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬å¯ä»¥ä» 0.0 ä¸­å‡å» 0ï¼Œä»è€ŒæŠŠæ­£çš„å’Œè´Ÿçš„é›¶éƒ½å˜æˆæ­£çš„ï¼š

```Java
System.out.println(0.0-(-0.0)); // 0.0
System.out.println(0.0-(+0.0)); // 0.0
```

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•é‡å†™å®ç°ï¼š

```Java
public static double abs(double value) {
  if (value <= 0) {
    return 0.0 - value;
  }
  return value;
}
```

å¦‚æœæˆ‘ä»¬è§‚å¯Ÿ IEEE-754 æ ¼å¼çš„ [åŒç²¾åº¦çš„äºŒè¿›åˆ¶è¡¨ç¤º](https://en.wikipedia.org/wiki/Double-precision_floating-point_format)ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¦å·åªæ˜¯ä¸€ä¸ªæœ€é«˜æœ‰æ•ˆä½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦æ— æ¡ä»¶åœ°æ¸…é™¤è¿™ä¸ª bitã€‚

åœ¨æ­¤æ“ä½œæœŸé—´ï¼Œæ•°å­—çš„å…¶ä½™éƒ¨åˆ†ä¸ä¼šæ›´æ”¹ã€‚åœ¨è¿™æ–¹é¢ï¼Œå°æ•°ç”šè‡³æ¯”æ•´æ•°æ›´ç®€å•ï¼Œè´Ÿæ•°é€šè¿‡äºŒçš„è¡¥æ•°å˜ä¸ºæ­£æ•°ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é‡æ–°è§£é‡Šä¸€ä¸ªåŒé‡æ•°å­—ï¼Œå¹¶ä¸”åœ¨æ“ä½œä¹‹åé‡æ–°è§£é‡Šå®ƒï¼š

```Java
public static double abs(double value) {
  return Double.longBitsToDouble(
    Double.doubleToRawLongBits(value) & 0x7fffffffffffffffL);
}
```


## tip [ğŸ”](#weekly-46)

### 1. [MDvideo: Markdown To Video](http://mdvideo.gshll.com/)

ä¸€ä¸ªå°† markdown æ–‡æ¡£è½¬ä¸ºè§†é¢‘çš„ä¾¿æ·å·¥å…·

## share [ğŸ”](#weekly-46)

[readme](../README.md) | [previous](202109W2.md) | [next](202109W4.md)
