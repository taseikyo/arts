> @Author  : Lewis Tian (taseikyo@gmail.com)
>
> @Link    : github.com/taseikyo
>
> @Range   : 2021-09-17 - 2021-09-17

# Weekly #46

[readme](../README.md) | [previous](202109W2.md) | [next](202109W4.md)

## Table of Contents

- [algorithm](#algorithm-)
- [review](#review-)
    - ç»å¯¹å€¼è®¡ç®—å¹¶ä¸ç®€å•ï¼ˆè‹±æ–‡ï¼‰
    - ä¸ºä»€ä¹ˆå¤§å¤šæ•°è½¯ä»¶å·¥ç¨‹å¸ˆæ›´å–œæ¬¢ macï¼ˆMedium :-1:ï¼‰
    - ç”¨ Golang åœ¨ç§’çº§è¯»å– 16GB çš„æ–‡ä»¶ï¼ˆMediumï¼‰
- [tip](#tip-)
    - MDvideo: Markdown To Video
- [share](#share-)

## algorithm [ğŸ”](#weekly-46)

## review [ğŸ”](#weekly-46)

### 1. [ç»å¯¹å€¼è®¡ç®—å¹¶ä¸ç®€å•](https://habr.com/en/post/574082)

è®¡ç®—ä¸€ä¸ªæ•°çš„ç»å¯¹å€¼çš„é—®é¢˜æ˜¯å®Œå…¨å¾®ä¸è¶³é“çš„ã€‚å¦‚æœæ•°å­—æ˜¯è´Ÿçš„ï¼Œæ”¹å˜ç¬¦å·ã€‚å¦åˆ™ï¼Œå°±è®©å®ƒä¿æŒåŸæ ·ã€‚

åœ¨ Java ä¸­ï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```Java
public static double abs(double value) {
  if (value < 0) {
    return -value;
  }
  return value;
}
```

åœ¨ [IEEE-754](https://en.wikipedia.org/wiki/IEEE_754-2008) æ ‡å‡†ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨ Java ä¸­ï¼Œæœ‰ä¸¤ä¸ªé›¶: `+0.0` å’Œ `-0.0`ï¼ŒæŠŠ 1.0 é™¤ä»¥ `+0.0` å’Œ `-0.0`ï¼Œä½ ä¼šå¾—åˆ°å®Œå…¨ä¸åŒçš„ç­”æ¡ˆ: `+Infinity` å’Œ ï¼Œåœ¨æ¯”è¾ƒæ“ä½œä¸­ï¼Œ`+0.0` å’Œ `-0.0` æ˜¯æ— æ³•åŒºåˆ†çš„ã€‚å› æ­¤ï¼Œä¸Šé¢çš„å®ç° `-0.0` çš„è½¬æ­£ï¼š

```Java
double x = -0.0;
if (1 / abs(x) < 0) {
  System.out.println("oops");
}
```

ç›´æ¥æ”¹ä¸º `if (value < 0 | | value =-0.0)` æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸º `+0.0 = -0.0`

ä¸ºäº†å¯é åœ°åŒºåˆ†ä»–ä»¬ä¿©ï¼Œæœ‰ä¸€ä¸ª `double.compare` æ–¹æ³•ï¼š

```Java
public static double abs(double value) {
  if (value < 0 || Double.compare(value, -0.0) == 0) {
    return -value;
  }
  return value;
}
```

ä¸Šè¿°æ–¹æ³•è™½ç„¶æœ‰æ•ˆï¼Œä½†æ˜¯å¯¹äºè¿™æ ·ä¸€ä¸ªç®€å•çš„æ“ä½œå˜å¾—éå¸¸æ…¢

å®ç° `double.compare` å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ã€‚å¯¹äºæ­£æ•°éœ€è¦ä¸¤æ¬¡é¢å¤–çš„æ¯”è¾ƒï¼Œå¯¹äº `-0.0` éœ€è¦ä¸‰æ¬¡æ¯”è¾ƒï¼Œå¯¹äº `+0.0` éœ€è¦å¤šè¾¾å››æ¬¡æ¯”è¾ƒã€‚


å¦‚æœçœ‹ä¸‹ [`double.compare` çš„æºç ](https://github.com/openjdk/jdk/blob/36e2ddad4d2ef3ce27475af6244d0246a8315c0c/src/java.base/share/classes/java/lang/Double.java#L1117)ï¼Œå¯ä»¥çœ‹åˆ°å®é™…ä¸Šæˆ‘ä»¬ä»…éœ€è¦ä¸€ä¸ª `doubleToLongBits`ï¼Œæ­¤æ–¹æ³•å°† `double` ç±»å‹çš„äºŒè¿›åˆ¶è¡¨ç¤ºé‡æ–°è§£é‡Šä¸º `long` ç±»å‹ï¼š

```Java
private static final long MINUS_ZERO_LONG_BITS =
  Double.doubleToLongBits(-0.0);

public static double abs(double value) {
  if (value < 0 ||
      Double.doubleToLongBits(value) == MINUS_ZERO_LONG_BITS) {
    return -value;
  }
  return value;
}
```

`doubleToLongBits` å°† NaN è§„èŒƒåŒ–ï¼ˆcanonicalizesï¼‰äº†ï¼Œ`doubleToLongBits` å°† NaN è½¬åŒ–ä¸º `0x7ff8000000000l`ï¼Œå¾ˆæ˜¾ç„¶åˆå¤šäº†æ¡ä»¶åˆ¤æ–­ã€‚

è¿˜æœ‰å¦ä¸€ç§æ–¹æ³• `doubleToRawLongBits`ã€‚å®ƒä¸æ‰§è¡Œä»»ä½•æ™ºèƒ½çš„ NaN è½¬æ¢ï¼Œåªæ˜¯è¿”å›å®Œå…¨ç›¸åŒçš„ä½è¡¨ç¤ºï¼š

```Java
private static final long MINUS_ZERO_LONG_BITS =
  Double.doubleToRawLongBits(-0.0);

public static double abs(double value) {
  if (value < 0 ||
      Double.doubleToRawLongBits(value) == MINUS_ZERO_LONG_BITS) {
    return -value;
  }
  return value;
}
```

JIT ç¼–è¯‘å™¨å¯ä»¥å®Œå…¨åˆ é™¤ doubleToRawLongBits æ–¹æ³•è°ƒç”¨ï¼Œå› ä¸ºè¿™åªæ˜¯é‡æ–°è§£é‡Š CPU å¯„å­˜å™¨ä¸­å­˜å‚¨çš„æ¯”ç‰¹é›†çš„é—®é¢˜ï¼Œè¿™æ · Java æ•°æ®ç±»å‹å°±ä¼šä¸€è‡´ã€‚

ä½†æ˜¯æ¯”ç‰¹æœ¬èº«ä¿æŒä¸å˜ï¼ŒCPU é€šå¸¸ä¸å…³å¿ƒæ•°æ®ç±»å‹ã€‚è™½ç„¶æœ‰ä¼ è¨€è¯´ï¼Œè¿™ä¸ªç”µè¯ä»ç„¶å¯èƒ½å¯¼è‡´ä»ä¸€ä¸ªæµ®ç‚¹å¯„å­˜å™¨è½¬ç§»åˆ°ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒè¿˜æ˜¯éå¸¸å¿«ã€‚

æˆ‘ä»¬èƒ½åšå¾—æ›´å°‘å—ï¼Ÿ

äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬å¯ä»¥ä» 0.0 ä¸­å‡å» 0ï¼Œä»è€ŒæŠŠæ­£çš„å’Œè´Ÿçš„é›¶éƒ½å˜æˆæ­£çš„ï¼š

```Java
System.out.println(0.0-(-0.0)); // 0.0
System.out.println(0.0-(+0.0)); // 0.0
```

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•é‡å†™å®ç°ï¼š

```Java
public static double abs(double value) {
  if (value <= 0) {
    return 0.0 - value;
  }
  return value;
}
```

å¦‚æœæˆ‘ä»¬è§‚å¯Ÿ IEEE-754 æ ¼å¼çš„ [åŒç²¾åº¦çš„äºŒè¿›åˆ¶è¡¨ç¤º](https://en.wikipedia.org/wiki/Double-precision_floating-point_format)ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¦å·åªæ˜¯ä¸€ä¸ªæœ€é«˜æœ‰æ•ˆä½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦æ— æ¡ä»¶åœ°æ¸…é™¤è¿™ä¸ª bitã€‚

åœ¨æ­¤æ“ä½œæœŸé—´ï¼Œæ•°å­—çš„å…¶ä½™éƒ¨åˆ†ä¸ä¼šæ›´æ”¹ã€‚åœ¨è¿™æ–¹é¢ï¼Œå°æ•°ç”šè‡³æ¯”æ•´æ•°æ›´ç®€å•ï¼Œè´Ÿæ•°é€šè¿‡äºŒçš„è¡¥æ•°å˜ä¸ºæ­£æ•°ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é‡æ–°è§£é‡Šä¸€ä¸ªåŒé‡æ•°å­—ï¼Œå¹¶ä¸”åœ¨æ“ä½œä¹‹åé‡æ–°è§£é‡Šå®ƒï¼š

```Java
public static double abs(double value) {
  return Double.longBitsToDouble(
    Double.doubleToRawLongBits(value) & 0x7fffffffffffffffL);
}
```

### 1. [ä¸ºä»€ä¹ˆå¤§å¤šæ•°è½¯ä»¶å·¥ç¨‹å¸ˆæ›´å–œæ¬¢ macï¼ˆMediumï¼‰](https://medium.com/codex/why-do-most-software-engineers-prefer-macbooks-f59a4ecdb124)

åƒåœ¾æ–‡ç« ä¹Ÿè¦ä¼šå‘˜å°±ç¦»è°±ã€‚

ä½œè€…è¯´äº†ä¸‹ä¸ºä»€ä¹ˆå¼€å‘è€…æ›´å–œæ¬¢ Mac çš„ 5 ä¸ªç†ç”±ï¼š

1ã€è‹¹æœçš„ç”Ÿæ€

2ã€è‹¹æœçš„æ“ä½œç³»ç»Ÿ

3ã€å¯é æ€§

è¿™ä¸€ç‚¹çœŸæ²¡ä½“ä¼šåˆ°ï¼Œå·²ç»æ”¶åˆ°ä¸¤å°å®‰å…¨éƒ¨é—¨çš„é‚®ä»¶é€šçŸ¥èµ¶ç´§å‡çº§ï¼Œæœ‰é«˜å±æ¼æ´ã€‚ã€‚

4ã€è®¾è®¡

è®¾ä¸€ç‚¹ç¡®å®ï¼ŒUI å’Œäº¤äº’ç¡®å®åŠæ‰“ Windows

5ã€ç‹¬å è½¯ä»¶

è¿™ä¸€ç‚¹åº”è¯¥éª‚è‹¹æœæ‰å¯¹

### 3. [ç”¨ Golang åœ¨ç§’çº§è¯»å– 16GB çš„æ–‡ä»¶ï¼ˆMediumï¼‰](https://medium.com/swlh/processing-16gb-file-in-seconds-go-lang-3982c235dfa2)

å½“ä»Šä¸–ç•Œçš„ä»»ä½•è®¡ç®—æœºç³»ç»Ÿæ¯å¤©éƒ½äº§ç”Ÿå¤§é‡çš„æ—¥å¿—æˆ–æ•°æ®ã€‚éšç€ç³»ç»Ÿçš„å‘å±•ï¼Œå°†è°ƒè¯•æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­æ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ä¸å¯å˜çš„ï¼Œè€Œä¸”åªèƒ½ç”¨äºåˆ†æå’Œæ•…éšœè§£å†³ç›®çš„ã€‚å› æ­¤ï¼Œç»„ç»‡å€¾å‘äºå°†å…¶å­˜å‚¨åœ¨é©»ç•™åœ¨æœ¬åœ°ç£ç›˜å­˜å‚¨å™¨ä¸­çš„æ–‡ä»¶ä¸­ã€‚

é¦–å…ˆç”¨æ ‡å‡†çš„ Go çš„ `os.File` æ¥å¤„ç†æ–‡ä»¶ IOï¼š

```Golang
f, err := os.Open(fileName)
 if err != nil {
   fmt.Println("cannot able to read the file", err)
   return
 }
// UPDATE: close after checking error
defer file.Close()  //Do not forget to close the file
```

ä¸€æ—¦æ‰“å¼€æ–‡ä»¶ï¼Œæœ‰ä¸¤ä¸ªé€‰é¡¹ç»§ç»­ï¼š

1ã€é€è¡Œè¯»å–æ–‡ä»¶ï¼Œè¿™æœ‰åŠ©äºå‡å°‘å¯¹å†…å­˜çš„å‹åŠ›ï¼Œä½†åœ¨ i/o ä¸­éœ€è¦æ›´å¤šçš„æ—¶é—´

2ã€ç«‹å³å°†æ•´ä¸ªæ–‡ä»¶è¯»å…¥å†…å­˜å¹¶å¤„ç†è¯¥æ–‡ä»¶ï¼Œè¿™å°†æ¶ˆè€—æ›´å¤šå†…å­˜ï¼Œä¸”ä¼šæ˜¾è‘—å¢åŠ æ—¶é—´

ç”±äºæ–‡ä»¶å¤ªå¤§ï¼Œä¸å¯èƒ½å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­

ä½†æ˜¯ç¬¬ä¸€ç§é€‰æ‹©ä¹Ÿæ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºæƒ³åœ¨ç§’çº§å¤„ç†æ–‡ä»¶

è¿˜æœ‰ç¬¬ä¸‰ç§é€‰æ‹©ï¼šä½¿ç”¨ `bufio.NewReader()` åˆ†å—åŠ è½½æ–‡ä»¶ï¼š

```Golang
r := bufio.NewReader(f)
for {
buf := make([]byte,4*1024) //the chunk size
n, err := r.Read(buf) //loading chunk into buffer
buf = buf[:n]
if n == 0 {
    if err != nil {
        fmt.Println(err)
        break
     }
    if err == io.EOF {
        break
    }
    return err
  }
}
```

å½“è¯»å–äº†ä¸€å—ï¼Œå¯ä»¥èµ·ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œè¿™æ ·å°±å¯ä»¥åŒæ—¶å¤„ç†æ¯ä¸ªå—ï¼š

```Golang
//sync pools to reuse the memory and decrease the preassure on //Garbage Collector
linesPool := sync.Pool{New: func() interface{} {
    lines := make([]byte, 500*1024)
    return lines
}}
stringPool := sync.Pool{New: func() interface{} {
    lines := ""
    return lines
}}
slicePool := sync.Pool{New: func() interface{} {
    lines := make([]string, 100)
    return lines
}}
r := bufio.NewReader(f)
var wg sync.WaitGroup //wait group to keep track off all threads
for {
    buf := linesPool.Get().([]byte)
    n, err := r.Read(buf)
    buf = buf[:n]
    if n == 0 {
        if err != nil {
            fmt.Println(err)
            break
        }
        if err == io.EOF {
            break
        }
        return err
     }
    nextUntillNewline, err := r.ReadBytes('\n')//read entire line

    if err != io.EOF {
        buf = append(buf, nextUntillNewline...)
    }

    wg.Add(1)
    go func() {

        //process each chunk concurrently
        //start -> log start time, end -> log end time

        ProcessChunk(buf, &linesPool, &stringPool, &slicePool, start, end)
        wg.Done()

    }()
}

wg.Wait()
}
```

åˆ©ç”¨äº†å¤šçº¿ç¨‹ï¼ˆgoroutineï¼‰ä¹‹åï¼Œå¤„ç†æ—¶é—´ä¸º 25 ç§’ã€‚

å®é™…ä¸Šä½œè€…å¯ä»¥è¯•è¯•å•çº¿ç¨‹ï¼Œç„¶åå¯¹æ¯”ä¸€ä¸‹æ—¶é—´æ”¹è¿›ï¼ˆ

ä»£ç ï¼š[process_16gb_file.go](../code/process_16gb_file.go)

## tip [ğŸ”](#weekly-46)

### 1. [MDvideo: Markdown To Video](http://mdvideo.gshll.com/)

ä¸€ä¸ªå°† markdown æ–‡æ¡£è½¬ä¸ºè§†é¢‘çš„ä¾¿æ·å·¥å…·

## share [ğŸ”](#weekly-46)

[readme](../README.md) | [previous](202109W2.md) | [next](202109W4.md)
