> @Author  : Lewis Tian (taseikyo@gmail.com)
>
> @Link    : github.com/taseikyo
>
> @Range   : 2024-05-12 - 2024-05-18

# Weekly #62

[readme](../README.md) | [previous](202405W1.md) | [next](202405W3.md)

![](../images/2024/05/tomas-malik-XhyMBMUCstA-unsplash.jpg "Weekly #62")

\**Photo by [Tomáš Malík](https://unsplash.com/@malcoo) on [Unsplash](https://unsplash.com/photos/a-car-is-parked-in-front-of-a-mountain-XhyMBMUCstA?utm_content=creditCopyText)*

## Table of Contents

- [algorithm](#algorithm-)
- [review](#review-)
- [tip](#tip-)
    - osv 添加自己的 c++ app 程序
    - 如何在一台机器上起多个 osv vm_osv 怎么登录不同的主机
    - osv 编译的 image 在不同机器上运行（同一个操作系统）_osv 可以在物理机上跑吗
- [share](#share-)

## algorithm [🔝](#weekly-62)

## review [🔝](#weekly-62)

## tip [🔝](#weekly-62)

### 1. [osv 添加自己的 c++ app 程序](https://blog.csdn.net/bamboojs/article/details/51360544)

```Bash
root@bamboo-VirtualBox:~/osv# cd ~/osv/apps
root@bamboo-VirtualBox:~/osv/apps# mkdir cpp-example

root@bamboo-VirtualBox:~/osv/apps/cpp-example# cat Makefile
module: hello_world.so
CFLAGS = -g -fPIC
CC = g++
%.o: %.cpp
        $(CC) -c $(CFLAGS) -o $@ $<


hello_world.so: hello_world.o
        $(CC) -shared -o $@ $^
clean:
        rm -f hello_world.so *.o
root@bamboo-VirtualBox:~/osv/apps/cpp-example# cat hello_world.cpp
#include <iostream>
using namespace std;
int main(){
        cout << "hello world!" << endl;
        return 0;
}
root@bamboo-VirtualBox:~/osv/apps/cpp-example# cat usr.manifest
/tools/hello_world.so: ${MODULE_DIR}/hello_world.so
root@bamboo-VirtualBox:~/osv/apps/cpp-example# cat module.py
from osv.modules import api


default = api.run('/tools/hello_world.so')
```

编译及执行

```Bash
./scripts/build image=cpp-example
./scripts/run.py -nv --verbose
```

说明：osv 的 app 类似于 linux 中的编译运行内核驱动，编译自己的模块，然后启动的时候注册运行（osv 本身就只有 kernel space）

### 2. [如何在一台机器上起多个 osv vm_osv 怎么登录不同的主机](https://blog.csdn.net/bamboojs/article/details/51596505)

在一台机器上起多个 osv，需要注意的是为虚拟机设置 mac 地址，要不然每次起虚拟机的时候都是相同的默认 mac，造成获取的 IP 地址相同

```Bash
root@bamboo-VirtualBox:~/osv# ./scripts/run.py -nv --novnc --nogdb --verbose
OSv v0.24-90-gabf49c0
4 CPUs detected
Firmware vendor: Bochs
bsd: initializing - done
VFS: mounting ramfs at /
VFS: mounting devfs at /dev
net: initializing - done
vga: Add VGA device instance
eth0: ethernet address: 52:54:00:12:34:56
virtio-blk: Add blk device instances 0 as vblk0, devsize=10737418240
random: virtio-rng registered as a source.
random: <Software, Yarrow> initialized
VFS: unmounting /dev
VFS: mounting zfs at /zfs
zfs: mounting osv/zfs from device /dev/vblk0.1
VFS: mounting devfs at /dev
VFS: mounting procfs at /proc
random: device unblocked.
program zpool.so returned 1
BSD shrinker: event handler list found: 0xffffa00001bd3580
        BSD shrinker found: 1
BSD shrinker: unlocked, running
[I/42 dhcp]: Waiting for IP...
[I/245 dhcp]: Server acknowledged IP for interface eth0
eth0: 192.168.122.89
[I/245 dhcp]: Configuring eth0: ip 192.168.122.89 subnet mask 255.255.255.0 gateway 192.168.122.1 MTU 1500
hello world!
Uncaught signal 2 ("Interrupt"). Powering off.
```

```Bash
root@bamboo-VirtualBox:~/osv# vim core/dhcp.cc ^C
root@bamboo-VirtualBox:~/osv# ./scripts/run.py -nv --novnc --nogdb --mac "52:54:00:12:34:5D" --verbose
OSv v0.24-90-gabf49c0
4 CPUs detected
Firmware vendor: Bochs
bsd: initializing - done
VFS: mounting ramfs at /
VFS: mounting devfs at /dev
net: initializing - done
vga: Add VGA device instance
eth0: ethernet address: 52:54:00:12:34:5d
virtio-blk: Add blk device instances 0 as vblk0, devsize=10737418240
random: virtio-rng registered as a source.
random: <Software, Yarrow> initialized
VFS: unmounting /dev
VFS: mounting zfs at /zfs
zfs: mounting osv/zfs from device /dev/vblk0.1
VFS: mounting devfs at /dev
VFS: mounting procfs at /proc
program zpool.so returned 1
BSD shrinker: event handler list found: 0xffffa00001bd3580
        BSD shrinker found: 1
BSD shrinker: unlocked, running
[I/42 dhcp]: Waiting for IP...
[I/245 dhcp]: Server acknowledged IP for interface eth0
eth0: 192.168.122.96
[I/245 dhcp]: Configuring eth0: ip 192.168.122.96 subnet mask 255.255.255.0 gateway 192.168.122.1 MTU 1500
hello world!
```

### 3. [osv 编译的 image 在不同机器上运行（同一个操作系统）_osv 可以在物理机上跑吗](https://blog.csdn.net/bamboojs/article/details/51360629)

我们使用上文中的 [cpp-example app](https://blog.csdn.net/bamboojs/article/details/51360544)

直接拷贝 image 到其他机器上，执行 start_vm.sh 脚本，注意需要通过 brctl 配置 virbr0 interface, 你也可以通过安装 libvirt 来实现。osv 本身提供 capstan 来管理 image

```bash
root@bamboo-VirtualBox:~/test# ls -al /root/osv/build/last/usr.img
-rw-r--r-- 1 root root 11534336 May  9 18:19 /root/osv/build/last/usr.img
```

usr.img 的大小才 11M，所以 osv boot 的时间那么快

```Bash
root@tis-S2600WT2:~/osv# ls -al
total 11280
drwxr-xr-x 2 root root     4096 May  8 20:44 .
drwx------ 6 root root     4096 May  8 20:44 ..
-rwxr----x 1 root root      103 May  8 20:44 qemu-ifup.sh
-rw-r--r-- 1 root root      437 May  8 20:44 start_vm.sh
-rw-r--r-- 1 root root 11534336 May  9 13:30 usr.img
```

```Bash
root@tis-S2600WT2:~/osv# cat qemu-ifup.sh
#!/bin/sh
export OSV_BRIDGE=virbr0
brctl stp $OSV_BRIDGE off
brctl addif $OSV_BRIDGE $1
ifconfig $1 up
```

```Bash
root@tis-S2600WT2:~/osv# cat start_vm.sh
qemu-system-x86_64 -m 2G -smp 4 -vnc :2 -gdb tcp::1234,server,nowait -device virtio-blk-pci,id=blk0,bootindex=0,drive=hd0,scsi=off -drive file=usr.img,if=none,id=hd0,cache=none,aio=native -netdev tap,id=hn0,script=qemu-ifup.sh,vhost=on -device virtio-net-pci,netdev=hn0,id=nic0 -redir tcp:2222::22 -device virtio-rng-pci -chardev stdio,mux=on,id=stdio,signal=off -mon chardev=stdio,mode=readline,default -device isa-serial,chardev=stdio
```


## share [🔝](#weekly-62)

[readme](../README.md) | [previous](202405W1.md) | [next](202405W3.md)
