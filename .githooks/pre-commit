#!/bin/bash
set -e

echo "ğŸ” pre-commit hook æ­£åœ¨æ‰§è¡Œï¼šæ£€æŸ¥é“¾æ¥æ˜¯å¦é‡å¤..."

# æå–æ–°å¢é“¾æ¥ï¼ˆæ”¯æŒ Markdown å’Œè£¸é“¾æ¥ï¼‰
new_links=$(git diff --cached --unified=0 | grep '^+' | grep -v '^+++' \
  | perl -nE '
      while (/\[[^\]]+\]\((https?:\/\/[^)]+)\)/g) { say $1 }
      while (/(https?:\/\/[^\s<>"'\''\)\]}]+)/g) { say $1 }
  ' | sort -u)

if [[ -z "$new_links" ]]; then
    echo "â„¹ï¸  æœ¬æ¬¡æäº¤æœªæ–°å¢é“¾æ¥ï¼Œè·³è¿‡æ£€æŸ¥ã€‚"
    exit 0
fi

echo "æœ¬æ¬¡æ–°å¢çš„é“¾æ¥ï¼š"
echo "$new_links"

map_file=$(mktemp)
existing_md_files=$(find weekly -type f -name "20*.md" | grep -v -Ff <(git diff --cached --name-only))

for file in $existing_md_files; do
    perl -nE '
        while (/\[[^\]]+\]\((https?:\/\/[^)]+)\)/g) { say "$1\t'"$file"'" }
        while (/(https?:\/\/[^\s<>"'\''\)\]}]+)/g) { say "$1\t'"$file"'" }
    ' "$file" >> "$map_file"
done

conflict_found=false
while read -r link; do
    match=$(grep -F "$link" "$map_file" || true)
    if [[ -n "$match" ]]; then
        if [ "$conflict_found" = false ]; then
            echo "âŒ æ£€æµ‹åˆ°é‡å¤é“¾æ¥ï¼Œç¦æ­¢æäº¤ï¼š"
            conflict_found=true
        fi
        echo "  - $link   â† å·²å‡ºç°åœ¨ $(echo "$match" | head -n1 | cut -f2)"
    fi
done <<< "$new_links"

rm -f "$map_file"

if [ "$conflict_found" = true ]; then
    exit 1
fi

echo "âœ… é“¾æ¥æ£€æŸ¥é€šè¿‡ï¼Œç»§ç»­æäº¤ã€‚"
exit 0
